<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Ardpicprog: ProgramEEPROM sketch</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Ardpicprog
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ProgramEEPROM sketch </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This sketch should be used in place of <a class="el" href="programpic_sketch.html">ProgramPIC</a> when programming a device from the 24LCXX family of standalone EEPROM's. The default implementation supports the 24LC256 device (and equivalent devices such as the 24FC256). Other devices in the family must be specified manually using the host program's <b>&ndash;device</b> option:</p>
<div class="fragment"><div class="line">ardpicprog -o out.hex --skip-ones    # defaults to 24lc256</div>
<div class="line">ardpicprog --device 24lc64 -o out.hex --skip-ones</div>
</div><!-- fragment --><p>The ZIF socket in the <a class="el" href="pic14_zif_circuit.html">PIC programmer shield</a> cannot be used directly with the 24LCXX family of EEPROM devices. An ICSP cable and adapter that uses the following circuit will be needed:</p>
<div class="image">
<img src="eeprom_circuit.png" alt="eeprom_circuit.png"/>
</div>
<p>Because the EEPROM does not use the MCLR/VPP pin on the ICSP header, it is not necessary to connect the 13 volt power supply to the shield while programming EEPROM's. The following photo shows the above circuit made up on a breadboard and connected to the programmer via an ICSP cable:</p>
<div class="image">
<img src="eeprom_circuit_inuse.jpg" alt="eeprom_circuit_inuse.jpg"/>
</div>
<p>The sketch treats the EEPROM as a collection of 16-bit words (LSB first) so as to be compatible with the word-oriented operation of <a class="el" href="programpic_sketch.html">ProgramPIC</a>. This means that the input HEX file must contain an even number of bytes. Each 16-bit word from the HEX file is written to two consecutive 8-bit bytes in the EEPROM's address space. This is slightly different to the handling of data memory in PIC devices which reads 16-bit words from the HEX file but writes only the LSB to the PIC.</p>
<p>The full source code for the ProgramEEPROM sketch follows:</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2012 Southern Storm Software, Pty Ltd.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This program is free software: you can redistribute it and/or modify</span></div>
<div class="line"><span class="comment"> * it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><span class="comment"> * the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="line"><span class="comment"> * (at your option) any later version.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><span class="comment"> * GNU General Public License for more details.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></div>
<div class="line"><span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;avr/pgmspace.h&gt;</span>       <span class="comment">// For PROGMEM</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Pin mappings for the PIC programming shield.</span></div>
<div class="line"><span class="preprocessor">#define PIN_MCLR        A1      // MCLR - not used for EEPROM mode.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_ACTIVITY    A5      // LED that indicates read/write activity</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_VDD         2       // Controls the power to the PIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_CLOCK       4       // Clock pin</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_DATA        7       // Data pin</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MCLR_RESET      HIGH    // PIN_MCLR state to reset the PIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MCLR_VPP        LOW     // PIN_MCLR state to apply 13v to MCLR/VPP pin</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// All delays are in microseconds.</span></div>
<div class="line"><span class="preprocessor">#define DELAY_SETTLE    50      // Delay for lines to settle for power off/on</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// States this application may be in.</span></div>
<div class="line"><span class="preprocessor">#define STATE_IDLE      0       // Idle, device is held in the reset state</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define STATE_PROGRAM   1       // Active, reading and writing memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordtype">int</span> state = STATE_IDLE;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Block select modes within the control byte.</span></div>
<div class="line"><span class="preprocessor">#define BSEL_NONE           0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BSEL_8BIT_ADDR      1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BSEL_17BIT_ADDR     2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BSEL_17BIT_ADDR_ALT 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">const</span> prog_char *eepromName;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> eepromSize;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> eepromEnd;</div>
<div class="line">byte eepromI2CAddress;</div>
<div class="line">byte eepromBlockSelectMode;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eepromPageSize;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Device names, forced out into PROGMEM.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc00[]   PROGMEM = <span class="stringliteral">&quot;24lc00&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc01[]   PROGMEM = <span class="stringliteral">&quot;24lc01&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc014[]  PROGMEM = <span class="stringliteral">&quot;24lc014&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc02[]   PROGMEM = <span class="stringliteral">&quot;24lc02&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc024[]  PROGMEM = <span class="stringliteral">&quot;24lc024&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc025[]  PROGMEM = <span class="stringliteral">&quot;24lc025&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc04[]   PROGMEM = <span class="stringliteral">&quot;24lc04&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc08[]   PROGMEM = <span class="stringliteral">&quot;24lc08&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc16[]   PROGMEM = <span class="stringliteral">&quot;24lc16&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc32[]   PROGMEM = <span class="stringliteral">&quot;24lc32&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc64[]   PROGMEM = <span class="stringliteral">&quot;24lc64&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc128[]  PROGMEM = <span class="stringliteral">&quot;24lc128&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc256[]  PROGMEM = <span class="stringliteral">&quot;24lc256&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc512[]  PROGMEM = <span class="stringliteral">&quot;24lc512&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc1025[] PROGMEM = <span class="stringliteral">&quot;24lc1025&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_24lc1026[] PROGMEM = <span class="stringliteral">&quot;24lc1026&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// List of devices that are currently supported and their properties.</span></div>
<div class="line"><span class="comment">// Note: most of these are based on published information and have not</span></div>
<div class="line"><span class="comment">// been tested by the author.  Patches welcome to improve the list.</span></div>
<div class="line"><span class="keyword">struct </span>deviceInfo</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> prog_char *name;      <span class="comment">// User-readable name of the device.</span></div>
<div class="line">    prog_uint32_t size;         <span class="comment">// Size of program memory (bytes).</span></div>
<div class="line">    prog_uint16_t pageSize;     <span class="comment">// Size of a page for bulk transfers.</span></div>
<div class="line">    prog_uint8_t address;       <span class="comment">// Address on the I2C bus.</span></div>
<div class="line">    prog_uint8_t blockSelect;   <span class="comment">// Block select mode.</span></div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"><span class="keyword">struct </span>deviceInfo const devices[] PROGMEM = {</div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21178H.pdf</span></div>
<div class="line">    {s_24lc00, 16UL, 1, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21711J.pdf</span></div>
<div class="line">    {s_24lc01, 128UL, 8, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21809G.pdf</span></div>
<div class="line">    {s_24lc014, 128UL, 16, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21709J.pdf</span></div>
<div class="line">    {s_24lc02, 256UL, 8, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21210N.pdf</span></div>
<div class="line">    {s_24lc024, 256UL, 16, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line">    {s_24lc025, 256UL, 16, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21708K.pdf</span></div>
<div class="line">    {s_24lc04, 512UL, 16, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21710K.pdf</span></div>
<div class="line">    {s_24lc08, 1024UL, 16, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21703K.pdf</span></div>
<div class="line">    {s_24lc16, 2048UL, 16, 0xA0, BSEL_8BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21713M.pdf</span></div>
<div class="line">    {s_24lc32, 4096UL, 32, 0xA0, BSEL_NONE},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21189S.pdf</span></div>
<div class="line">    {s_24lc64, 8192UL, 32, 0xA0, BSEL_NONE},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21191s.pdf</span></div>
<div class="line">    {s_24lc128, 16384UL, 64, 0xA0, BSEL_NONE},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21203R.pdf</span></div>
<div class="line">    {s_24lc256, 32768UL, 64, 0xA0, BSEL_NONE},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21754M.pdf</span></div>
<div class="line">    {s_24lc512, 65536UL, 128, 0xA0, BSEL_NONE},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/21941K.pdf</span></div>
<div class="line">    {s_24lc1025, 131072UL, 128, 0xA0, BSEL_17BIT_ADDR_ALT},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/22270C.pdf</span></div>
<div class="line">    {s_24lc1026, 131072UL, 128, 0xA0, BSEL_17BIT_ADDR},</div>
<div class="line"></div>
<div class="line">    {0, 0, 0, 0, 0}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Buffer for command-line character input and READBIN data packets.</span></div>
<div class="line"><span class="preprocessor">#define BINARY_TRANSFER_MAX 64</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BUFFER_MAX (BINARY_TRANSFER_MAX + 1)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordtype">char</span> buffer[BUFFER_MAX];</div>
<div class="line"><span class="keywordtype">int</span> buflen = 0;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lastActive = 0;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> setup()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Need a serial link to the host.</span></div>
<div class="line">    Serial.begin(9600);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initialize the defaults for the 24LC256.</span></div>
<div class="line">    setDefaultDeviceInfo();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Hold the chip in the powered down/reset state until we are ready for it.</span></div>
<div class="line">    pinMode(PIN_MCLR, OUTPUT);</div>
<div class="line">    pinMode(PIN_VDD, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_MCLR, MCLR_RESET);</div>
<div class="line">    digitalWrite(PIN_VDD, LOW);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initially set the CLOCK and DATA lines to be outputs in the high state.</span></div>
<div class="line">    pinMode(PIN_CLOCK, OUTPUT);</div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">    digitalWrite(PIN_DATA, HIGH);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Turn off the activity LED initially.</span></div>
<div class="line">    pinMode(PIN_ACTIVITY, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> loop()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (Serial.available()) {</div>
<div class="line">        <span class="comment">// Process serial input for commands from the host.</span></div>
<div class="line">        <span class="keywordtype">int</span> ch = Serial.read();</div>
<div class="line">        <span class="keywordflow">if</span> (ch == 0x0A || ch == 0x0D) {</div>
<div class="line">            <span class="comment">// End of the current command.  Blank lines are ignored.</span></div>
<div class="line">            <span class="keywordflow">if</span> (buflen &gt; 0) {</div>
<div class="line">                buffer[buflen] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">                buflen = 0;</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, HIGH);   <span class="comment">// Turn on activity LED.</span></div>
<div class="line">                processCommand(buffer);</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, LOW);    <span class="comment">// Turn off activity LED.</span></div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == 0x08) {</div>
<div class="line">            <span class="comment">// Backspace over the last character.</span></div>
<div class="line">            <span class="keywordflow">if</span> (buflen &gt; 0)</div>
<div class="line">                --buflen;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buflen &lt; (BUFFER_MAX - 1)) {</div>
<div class="line">            <span class="comment">// Add the character to the buffer after forcing to upper case.</span></div>
<div class="line">            <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line">                buffer[buflen++] = ch - <span class="charliteral">&#39;a&#39;</span> + <span class="charliteral">&#39;A&#39;</span>;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                buffer[buflen++] = ch;</div>
<div class="line">        }</div>
<div class="line">        lastActive = millis();</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state != STATE_IDLE) {</div>
<div class="line">        <span class="comment">// Power off the programming socket if no activity for 2 seconds.</span></div>
<div class="line">        <span class="comment">// Normally the host will issue the &quot;PWROFF&quot; command, but if we are</span></div>
<div class="line">        <span class="comment">// operating in interactive mode or the host has crashed, then this</span></div>
<div class="line">        <span class="comment">// timeout will ensure that the system eventually enters safe mode.</span></div>
<div class="line">        <span class="keywordflow">if</span> ((millis() - lastActive) &gt;= 2000)</div>
<div class="line">            exitProgramMode();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printHex1(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (value &gt;= 10)</div>
<div class="line">        Serial.print((<span class="keywordtype">char</span>)(<span class="charliteral">&#39;A&#39;</span> + value - 10));</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        Serial.print((<span class="keywordtype">char</span>)(<span class="charliteral">&#39;0&#39;</span> + value));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printHex4(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word)</div>
<div class="line">{</div>
<div class="line">    printHex1((word &gt;&gt; 12) &amp; 0x0F);</div>
<div class="line">    printHex1((word &gt;&gt; 8) &amp; 0x0F);</div>
<div class="line">    printHex1((word &gt;&gt; 4) &amp; 0x0F);</div>
<div class="line">    printHex1(word &amp; 0x0F);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printHex8(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> word)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> upper = (<span class="keywordtype">unsigned</span> int)(word &gt;&gt; 16);</div>
<div class="line">    <span class="keywordflow">if</span> (upper)</div>
<div class="line">        printHex4(upper);</div>
<div class="line">    printHex4((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)word);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printProgString(<span class="keyword">const</span> prog_char *str)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = (char)(pgm_read_byte(str));</div>
<div class="line">        <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        Serial.print(ch);</div>
<div class="line">        ++str;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// PROGRAM_PIC_VERSION command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdVersion(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;ProgramPIC 1.0&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Set the defaults for the 24LC256.</span></div>
<div class="line"><span class="keywordtype">void</span> setDefaultDeviceInfo()</div>
<div class="line">{</div>
<div class="line">    eepromName = s_24lc256;</div>
<div class="line">    eepromSize = 32768UL;</div>
<div class="line">    eepromEnd = (eepromSize / 2) - 1;</div>
<div class="line">    eepromI2CAddress = 0xA0;</div>
<div class="line">    eepromBlockSelectMode = BSEL_NONE;</div>
<div class="line">    eepromPageSize = 64;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Print the device information.</span></div>
<div class="line"><span class="keywordtype">void</span> printDeviceInfo()</div>
<div class="line">{</div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;DeviceName: &quot;</span>);</div>
<div class="line">    printProgString(eepromName);</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;DataRange: 0000-&quot;</span>);</div>
<div class="line">    printHex8(eepromEnd);</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;DataBits: 16&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Initialize device properties from the &quot;devices&quot; list.</span></div>
<div class="line"><span class="comment">// Note: &quot;dev&quot; is in PROGMEM.</span></div>
<div class="line"><span class="keywordtype">void</span> initDevice(<span class="keyword">const</span> <span class="keyword">struct</span> deviceInfo *dev)</div>
<div class="line">{</div>
<div class="line">    eepromName = (<span class="keyword">const</span> prog_char *)pgm_read_word(&amp;(dev-&gt;name));</div>
<div class="line">    eepromSize = pgm_read_dword(&amp;(dev-&gt;size));</div>
<div class="line">    eepromEnd = (eepromSize / 2) - 1;</div>
<div class="line">    eepromI2CAddress = pgm_read_byte(&amp;(dev-&gt;address));</div>
<div class="line">    eepromBlockSelectMode = pgm_read_byte(&amp;(dev-&gt;blockSelect));</div>
<div class="line">    eepromPageSize = pgm_read_word(&amp;(dev-&gt;pageSize));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// DEVICE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdDevice(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Start with the chip powered off.</span></div>
<div class="line">    exitProgramMode();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Probe the I2C bus to see if we have a working EEPROM.</span></div>
<div class="line">    setDefaultDeviceInfo();</div>
<div class="line">    <span class="keywordflow">if</span> (!probeDevice()) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line"></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;DeviceID: 0000&quot;</span>);</div>
<div class="line"></div>
<div class="line">    printDeviceInfo();</div>
<div class="line"></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// DEVICES command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdDevices(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(devices[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (index &gt; 0) {</div>
<div class="line">            Serial.print(<span class="charliteral">&#39;,&#39;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> ((index % 6) == 0)</div>
<div class="line">                Serial.println();</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                Serial.print(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">        }</div>
<div class="line">        printProgString(name);</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size = pgm_read_dword(&amp;(devices[index].size));</div>
<div class="line">        <span class="keywordflow">if</span> (size == 32768UL)    <span class="comment">// 24LC256 is the default</span></div>
<div class="line">            Serial.print(<span class="charliteral">&#39;*&#39;</span>);</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// SETDEVICE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdSetDevice(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Start with the chip powered off.</span></div>
<div class="line">    exitProgramMode();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Extract the name of the device from the command arguments.</span></div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = args[len];</div>
<div class="line">        <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;\0&#39;</span> || ch == <span class="charliteral">&#39; &#39;</span> || ch == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++len;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Look for the name in the devices list.</span></div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(devices[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (matchString(name, args, len)) {</div>
<div class="line">            initDevice(&amp;(devices[index]));</div>
<div class="line">            <span class="keywordflow">if</span> (!probeDevice()) {</div>
<div class="line">                <span class="comment">// No device on the bus.</span></div>
<div class="line">                setDefaultDeviceInfo();</div>
<div class="line">                Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                exitProgramMode();</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">            printDeviceInfo();</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line">    setDefaultDeviceInfo();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> parseHex(<span class="keyword">const</span> <span class="keywordtype">char</span> *args, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> size = 0;</div>
<div class="line">    *value = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = *args;</div>
<div class="line">        <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;0&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;9&#39;</span>)</div>
<div class="line">            *value = (*value &lt;&lt; 4) | (ch - <span class="charliteral">&#39;0&#39;</span>);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;A&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;F&#39;</span>)</div>
<div class="line">            *value = (*value &lt;&lt; 4) | (ch - <span class="charliteral">&#39;A&#39;</span> + 10);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;f&#39;</span>)</div>
<div class="line">            *value = (*value &lt;&lt; 4) | (ch - <span class="charliteral">&#39;a&#39;</span> + 10);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++size;</div>
<div class="line">        ++args;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (*args != <span class="charliteral">&#39;\0&#39;</span> &amp;&amp; *args != <span class="charliteral">&#39;-&#39;</span> &amp;&amp; *args != <span class="charliteral">&#39; &#39;</span> &amp;&amp; *args != <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    <span class="keywordflow">return</span> size;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Parse a range of addresses of the form START or START-END.</span></div>
<div class="line"><span class="keywordtype">bool</span> parseRange(<span class="keyword">const</span> <span class="keywordtype">char</span> *args, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *end)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> size = parseHex(args, start);</div>
<div class="line">    <span class="keywordflow">if</span> (!size)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    args += size;</div>
<div class="line">    <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++args;</div>
<div class="line">    <span class="keywordflow">if</span> (*args != <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">        *end = *start;</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    ++args;</div>
<div class="line">    <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++args;</div>
<div class="line">    <span class="keywordflow">if</span> (!parseHex(args, end))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">return</span> *end &gt;= *start;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> parseCheckedRange(<span class="keyword">const</span> <span class="keywordtype">char</span> *args, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *end)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Parse the basic values and make sure that start &lt;= end.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!parseRange(args, start, end))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check that both start and end are within the same memory area</span></div>
<div class="line">    <span class="comment">// and within the bounds of that memory area.</span></div>
<div class="line">    <span class="keywordflow">if</span> (*start &lt;= eepromEnd) {</div>
<div class="line">        <span class="keywordflow">if</span> (*end &gt; eepromEnd)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// READ command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdRead(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> end;</div>
<div class="line">    <span class="keywordflow">if</span> (!parseCheckedRange(args, &amp;start, &amp;end)) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!startRead(start)) {</div>
<div class="line">        <span class="comment">// No device on the bus.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> activity = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">while</span> (start &lt;= end) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word = readWord(start == end);</div>
<div class="line">        <span class="keywordflow">if</span> (count &gt; 0) {</div>
<div class="line">            <span class="keywordflow">if</span> ((count % 8) == 0)</div>
<div class="line">                Serial.println();</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                Serial.print(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">        }</div>
<div class="line">        printHex4(word);</div>
<div class="line">        ++start;</div>
<div class="line">        ++count;</div>
<div class="line">        <span class="keywordflow">if</span> ((count % 32) == 0) {</div>
<div class="line">            <span class="comment">// Toggle the activity LED to make it blink during long reads.</span></div>
<div class="line">            activity = !activity;</div>
<div class="line">            <span class="keywordflow">if</span> (activity)</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, HIGH);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// READBIN command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdReadBinary(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> end;</div>
<div class="line">    <span class="keywordflow">if</span> (!parseCheckedRange(args, &amp;start, &amp;end)) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!startRead(start)) {</div>
<div class="line">        <span class="comment">// No device on the bus.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> activity = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordtype">size_t</span> offset = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (start &lt;= end) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word = readWord(start == end);</div>
<div class="line">        buffer[++offset] = (char)word;</div>
<div class="line">        buffer[++offset] = (char)(word &gt;&gt; 8);</div>
<div class="line">        <span class="keywordflow">if</span> (offset &gt;= BINARY_TRANSFER_MAX) {</div>
<div class="line">            <span class="comment">// Buffer is full - flush it to the host.</span></div>
<div class="line">            buffer[0] = (char)offset;</div>
<div class="line">            Serial.write((<span class="keyword">const</span> uint8_t *)buffer, offset + 1);</div>
<div class="line">            offset = 0;</div>
<div class="line">        }</div>
<div class="line">        ++start;</div>
<div class="line">        ++count;</div>
<div class="line">        <span class="keywordflow">if</span> ((count % 64) == 0) {</div>
<div class="line">            <span class="comment">// Toggle the activity LED to make it blink during long reads.</span></div>
<div class="line">            activity = !activity;</div>
<div class="line">            <span class="keywordflow">if</span> (activity)</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, HIGH);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (offset &gt; 0) {</div>
<div class="line">        <span class="comment">// Flush the final packet before the terminator.</span></div>
<div class="line">        buffer[0] = (char)offset;</div>
<div class="line">        Serial.write((<span class="keyword">const</span> uint8_t *)buffer, offset + 1);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Write the terminator (a zero-length packet).</span></div>
<div class="line">    Serial.write((uint8_t)0x00);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// WRITE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdWrite(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> limit;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> value;</div>
<div class="line">    <span class="keywordtype">int</span> size;</div>
<div class="line">    size = parseHex(args, &amp;addr);</div>
<div class="line">    <span class="keywordflow">if</span> (!size) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    args += size;</div>
<div class="line">    <span class="keywordflow">if</span> (addr &lt;= eepromEnd) {</div>
<div class="line">        limit = eepromEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Address is not within one of the valid ranges.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    startWrite(addr);</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            ++args;</div>
<div class="line">        <span class="keywordflow">if</span> (*args == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (*args == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">            stopWrite();</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        size = parseHex(args, &amp;value);</div>
<div class="line">        <span class="keywordflow">if</span> (!size) {</div>
<div class="line">            stopWrite();</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        args += size;</div>
<div class="line">        <span class="keywordflow">if</span> (addr &gt; limit) {</div>
<div class="line">            <span class="comment">// We&#39;ve reached the limit of this memory area, so fail.</span></div>
<div class="line">            stopWrite();</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (!writeWord((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)value)) {</div>
<div class="line">            <span class="comment">// The actual write to the device failed.</span></div>
<div class="line">            stopWrite();</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        ++addr;</div>
<div class="line">        ++count;</div>
<div class="line">    }</div>
<div class="line">    stopWrite();</div>
<div class="line">    <span class="keywordflow">if</span> (!count) {</div>
<div class="line">        <span class="comment">// Missing word argument.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Blocking serial read for use by WRITEBIN.</span></div>
<div class="line"><span class="keywordtype">int</span> readBlocking()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (!Serial.available())</div>
<div class="line">        ;   <span class="comment">// Do nothing.</span></div>
<div class="line">    <span class="keywordflow">return</span> Serial.read();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// WRITEBIN command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdWriteBinary(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> limit;</div>
<div class="line">    <span class="keywordtype">int</span> size;</div>
<div class="line">    size = parseHex(args, &amp;addr);</div>
<div class="line">    <span class="keywordflow">if</span> (!size) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    args += size;</div>
<div class="line">    <span class="keywordflow">if</span> (addr &lt;= eepromEnd) {</div>
<div class="line">        limit = eepromEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Address is not within one of the valid ranges.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    startWrite(addr);</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> activity = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="comment">// Read in the next binary packet.</span></div>
<div class="line">        <span class="keywordtype">int</span> len = readBlocking();</div>
<div class="line">        <span class="keywordflow">while</span> (len == 0x0A &amp;&amp; count == 0) {</div>
<div class="line">            <span class="comment">// Skip 0x0A bytes before the first packet as they are</span></div>
<div class="line">            <span class="comment">// probably part of a CRLF pair rather than a packet length.</span></div>
<div class="line">            len = readBlocking();</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Stop if we have a zero packet length - end of upload.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!len)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Read the contents of the packet from the serial input stream.</span></div>
<div class="line">        <span class="keywordtype">int</span> offset = 0;</div>
<div class="line">        <span class="keywordflow">while</span> (offset &lt; len) {</div>
<div class="line">            <span class="keywordflow">if</span> (offset &lt; BINARY_TRANSFER_MAX) {</div>
<div class="line">                buffer[offset++] = (char)readBlocking();</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                readBlocking();     <span class="comment">// Packet is too big - discard extra bytes.</span></div>
<div class="line">                ++offset;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Write the words to memory.</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> posn = 0; posn &lt; (len - 1); posn += 2) {</div>
<div class="line">            <span class="keywordflow">if</span> (addr &gt; limit) {</div>
<div class="line">                <span class="comment">// We&#39;ve reached the limit of this memory area, so fail.</span></div>
<div class="line">                stopWrite();</div>
<div class="line">                Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> value =</div>
<div class="line">                (((<span class="keywordtype">unsigned</span> int)buffer[posn]) &amp; 0xFF) |</div>
<div class="line">                ((((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)buffer[posn + 1]) &amp; 0xFF) &lt;&lt; 8);</div>
<div class="line">            <span class="keywordflow">if</span> (!writeWord((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)value)) {</div>
<div class="line">                <span class="comment">// The actual write to the device failed.</span></div>
<div class="line">                stopWrite();</div>
<div class="line">                Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">            ++addr;</div>
<div class="line">            ++count;</div>
<div class="line">            <span class="keywordflow">if</span> ((count % 24) == 0) {</div>
<div class="line">                <span class="comment">// Toggle the activity LED to make it blink during long writes.</span></div>
<div class="line">                activity = !activity;</div>
<div class="line">                <span class="keywordflow">if</span> (activity)</div>
<div class="line">                    digitalWrite(PIN_ACTIVITY, HIGH);</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// All words in this packet have been written successfully.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    stopWrite();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ERASE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdErase(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (eraseAll())</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// PWROFF command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdPowerOff(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    exitProgramMode();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// List of all commands that are understood by the programmer.</span></div>
<div class="line"><span class="keyword">typedef</span> void (*commandFunc)(<span class="keyword">const</span> <span class="keywordtype">char</span> *args);</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> prog_char *name;</div>
<div class="line">    commandFunc func;</div>
<div class="line">    <span class="keyword">const</span> prog_char *desc;</div>
<div class="line">    <span class="keyword">const</span> prog_char *args;</div>
<div class="line">} command_t;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdRead[] PROGMEM = <span class="stringliteral">&quot;READ&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Reads program and data words from device memory (text)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadArgs[] PROGMEM = <span class="stringliteral">&quot;STARTADDR[-ENDADDR]&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadBinary[] PROGMEM = <span class="stringliteral">&quot;READBIN&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadBinaryDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Reads program and data words from device memory (binary)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWrite[] PROGMEM = <span class="stringliteral">&quot;WRITE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Writes program and data words to device memory (text)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteArgs[] PROGMEM = <span class="stringliteral">&quot;STARTADDR WORD [WORD ...]&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteBinary[] PROGMEM = <span class="stringliteral">&quot;WRITEBIN&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteBinaryDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Writes program and data words to device memory (binary)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteBinaryArgs[] PROGMEM = <span class="stringliteral">&quot;STARTADDR&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdErase[] PROGMEM = <span class="stringliteral">&quot;ERASE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdEraseDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Erases the contents of program, configuration, and data memory&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDevice[] PROGMEM = <span class="stringliteral">&quot;DEVICE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDeviceDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Probes the device and returns information about it&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDevices[] PROGMEM = <span class="stringliteral">&quot;DEVICES&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDevicesDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Returns a list of all supported device types&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdSetDevice[] PROGMEM = <span class="stringliteral">&quot;SETDEVICE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdSetDeviceDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Sets a specific device type manually&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdSetDeviceArgs[] PROGMEM = <span class="stringliteral">&quot;DEVTYPE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdPowerOff[] PROGMEM = <span class="stringliteral">&quot;PWROFF&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdPowerOffDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Powers off the device in the programming socket&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdVersion[] PROGMEM = <span class="stringliteral">&quot;PROGRAM_PIC_VERSION&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdVersionDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Prints the version of ProgramPIC&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdHelp[] PROGMEM = <span class="stringliteral">&quot;HELP&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdHelpDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Prints this help message&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> command_t commands[] PROGMEM = {</div>
<div class="line">    {s_cmdRead, cmdRead, s_cmdReadDesc, s_cmdReadArgs},</div>
<div class="line">    {s_cmdReadBinary, cmdReadBinary, s_cmdReadBinaryDesc, s_cmdReadArgs},</div>
<div class="line">    {s_cmdWrite, cmdWrite, s_cmdWriteDesc, s_cmdWriteArgs},</div>
<div class="line">    {s_cmdWriteBinary, cmdWriteBinary, s_cmdWriteBinaryDesc, s_cmdWriteBinaryArgs},</div>
<div class="line">    {s_cmdErase, cmdErase, s_cmdEraseDesc, 0},</div>
<div class="line">    {s_cmdDevice, cmdDevice, s_cmdDeviceDesc, 0},</div>
<div class="line">    {s_cmdDevices, cmdDevices, s_cmdDevicesDesc, 0},</div>
<div class="line">    {s_cmdSetDevice, cmdSetDevice, s_cmdSetDeviceDesc, s_cmdSetDeviceArgs},</div>
<div class="line">    {s_cmdPowerOff, cmdPowerOff, s_cmdPowerOffDesc, 0},</div>
<div class="line">    {s_cmdVersion, cmdVersion, s_cmdVersionDesc, 0},</div>
<div class="line">    {s_cmdHelp, cmdHelp, s_cmdHelpDesc, 0},</div>
<div class="line">    {0, 0}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// &quot;HELP&quot; command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdHelp(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keyword">const</span> prog_char *desc = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].desc)));</div>
<div class="line">        <span class="keyword">const</span> prog_char *args = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].args)));</div>
<div class="line">        printProgString(name);</div>
<div class="line">        <span class="keywordflow">if</span> (args) {</div>
<div class="line">            Serial.print(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">            printProgString(args);</div>
<div class="line">        }</div>
<div class="line">        Serial.println();</div>
<div class="line">        Serial.print(<span class="stringliteral">&quot;    &quot;</span>);</div>
<div class="line">        printProgString(desc);</div>
<div class="line">        Serial.println();</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Match a data-space string where the name comes from PROGMEM.</span></div>
<div class="line"><span class="keywordtype">bool</span> matchString(<span class="keyword">const</span> prog_char *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> len)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch1 = (char)(pgm_read_byte(name));</div>
<div class="line">        <span class="keywordflow">if</span> (ch1 == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">            <span class="keywordflow">return</span> len == 0;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len == 0)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (ch1 &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch1 &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line">            ch1 = ch1 - <span class="charliteral">&#39;a&#39;</span> + <span class="charliteral">&#39;A&#39;</span>;</div>
<div class="line">        <span class="keywordtype">char</span> ch2 = *str;</div>
<div class="line">        <span class="keywordflow">if</span> (ch2 &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch2 &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line">            ch2 = ch2 - <span class="charliteral">&#39;a&#39;</span> + <span class="charliteral">&#39;A&#39;</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (ch1 != ch2)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++name;</div>
<div class="line">        ++str;</div>
<div class="line">        --len;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Process commands from the host.</span></div>
<div class="line"><span class="keywordtype">void</span> processCommand(<span class="keyword">const</span> <span class="keywordtype">char</span> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Skip white space at the start of the command.</span></div>
<div class="line">    <span class="keywordflow">while</span> (*buf == <span class="charliteral">&#39; &#39;</span> || *buf == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++buf;</div>
<div class="line">    <span class="keywordflow">if</span> (*buf == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;     <span class="comment">// Ignore blank lines.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Extract the command portion of the line.</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd = buf;</div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = *buf;</div>
<div class="line">        <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;\0&#39;</span> || ch == <span class="charliteral">&#39; &#39;</span> || ch == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++buf;</div>
<div class="line">        ++len;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Skip white space after the command name and before the arguments.</span></div>
<div class="line">    <span class="keywordflow">while</span> (*buf == <span class="charliteral">&#39; &#39;</span> || *buf == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++buf;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Find the command and execute it.</span></div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (matchString(name, cmd, len)) {</div>
<div class="line">            commandFunc func =</div>
<div class="line">                (commandFunc)(pgm_read_word(&amp;(commands[index].func)));</div>
<div class="line">            (*func)(buf);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Unknown command.</span></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;NOTSUPPORTED&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Enter programming mode.</span></div>
<div class="line"><span class="keywordtype">void</span> enterProgramMode()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Bail out if already in programming mode.</span></div>
<div class="line">    <span class="keywordflow">if</span> (state != STATE_IDLE)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Lower VDD, which will power off the chip just in case.</span></div>
<div class="line">    digitalWrite(PIN_VDD, LOW);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Make sure that CLOCK and DATA are high.</span></div>
<div class="line">    pinMode(PIN_CLOCK, OUTPUT);</div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">    digitalWrite(PIN_DATA, HIGH);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Wait for the lines to settle.</span></div>
<div class="line">    delayMicroseconds(DELAY_SETTLE);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Raise VDD.</span></div>
<div class="line">    digitalWrite(PIN_VDD, HIGH);</div>
<div class="line">    delayMicroseconds(DELAY_SETTLE);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Now in program mode, address not set yet.</span></div>
<div class="line">    state = STATE_PROGRAM;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Exit programming mode and reset the device.</span></div>
<div class="line"><span class="keywordtype">void</span> exitProgramMode()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Nothing to do if already out of programming mode.</span></div>
<div class="line">    <span class="keywordflow">if</span> (state == STATE_IDLE)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Lower VDD.</span></div>
<div class="line">    digitalWrite(PIN_VDD, LOW);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Return the CLOCK and DATA lines to the pulled-high state.</span></div>
<div class="line">    pinMode(PIN_CLOCK, OUTPUT);</div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">    digitalWrite(PIN_DATA, HIGH);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Now in the idle state with the chip powered off.</span></div>
<div class="line">    state = STATE_IDLE;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Details of the I2C protocol here: http://en.wikipedia.org/wiki/I2C</span></div>
<div class="line"><span class="comment">// Assumptions: only one master, no arbitration, and no clock stretching.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define i2cDelay()  delayMicroseconds(5)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">bool</span> started = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> i2cStart()</div>
<div class="line">{</div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    <span class="keywordflow">if</span> (started) {</div>
<div class="line">        <span class="comment">// Already started, so send a restart condition.</span></div>
<div class="line">        digitalWrite(PIN_DATA, HIGH);</div>
<div class="line">        digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">        i2cDelay();</div>
<div class="line">    }</div>
<div class="line">    digitalWrite(PIN_DATA, LOW);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    started = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> i2cStop()</div>
<div class="line">{</div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_DATA, LOW);</div>
<div class="line">    digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    digitalWrite(PIN_DATA, HIGH);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    started = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> i2cWriteBit(<span class="keywordtype">bool</span> bit)</div>
<div class="line">{</div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    <span class="keywordflow">if</span> (bit)</div>
<div class="line">        digitalWrite(PIN_DATA, HIGH);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        digitalWrite(PIN_DATA, LOW);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line">    i2cDelay();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">bool</span> i2cReadBit()</div>
<div class="line">{</div>
<div class="line">    pinMode(PIN_DATA, INPUT);</div>
<div class="line">    digitalWrite(PIN_DATA, HIGH);</div>
<div class="line">    digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">    <span class="keywordtype">bool</span> bit = digitalRead(PIN_DATA);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line">    i2cDelay();</div>
<div class="line">    <span class="keywordflow">return</span> bit;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define I2C_ACK     false</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define I2C_NACK    true</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">bool</span> i2cWrite(byte value)</div>
<div class="line">{</div>
<div class="line">    byte mask = 0x80;</div>
<div class="line">    <span class="keywordflow">while</span> (mask != 0) {</div>
<div class="line">        i2cWriteBit((value &amp; mask) != 0);</div>
<div class="line">        mask &gt;&gt;= 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> i2cReadBit();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">byte i2cRead(<span class="keywordtype">bool</span> nack)</div>
<div class="line">{</div>
<div class="line">    byte value = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (byte bit = 0; bit &lt; 8; ++bit)</div>
<div class="line">        value = (value &lt;&lt; 1) | i2cReadBit();</div>
<div class="line">    i2cWriteBit(nack);</div>
<div class="line">    <span class="keywordflow">return</span> value;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define I2C_READ    0x01</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define I2C_WRITE   0x00</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">bool</span> writeAddress(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> byteAddr)</div>
<div class="line">{</div>
<div class="line">    byte ctrl;</div>
<div class="line">    <span class="keywordflow">switch</span> (eepromBlockSelectMode) {</div>
<div class="line">    <span class="keywordflow">case</span> BSEL_NONE:</div>
<div class="line">        <span class="keywordflow">if</span> (i2cWrite(eepromI2CAddress | I2C_WRITE) == I2C_NACK)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        i2cWrite((byte)(byteAddr &gt;&gt; 8));</div>
<div class="line">        i2cWrite((byte)byteAddr);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> BSEL_8BIT_ADDR:</div>
<div class="line">        ctrl = eepromI2CAddress | ((byte)(byteAddr &gt;&gt; 7) &amp; 0x0E) | I2C_WRITE;</div>
<div class="line">        <span class="keywordflow">if</span> (i2cWrite(ctrl) == I2C_NACK)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        i2cWrite((byte)byteAddr);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> BSEL_17BIT_ADDR:</div>
<div class="line">        ctrl = eepromI2CAddress | ((byte)(byteAddr &gt;&gt; 15) &amp; 0x02) | I2C_WRITE;</div>
<div class="line">        <span class="keywordflow">if</span> (i2cWrite(ctrl) == I2C_NACK)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        i2cWrite((byte)(byteAddr &gt;&gt; 8));</div>
<div class="line">        i2cWrite((byte)byteAddr);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> BSEL_17BIT_ADDR_ALT:</div>
<div class="line">        ctrl = eepromI2CAddress | ((byte)(byteAddr &gt;&gt; 13) &amp; 0x08) | I2C_WRITE;</div>
<div class="line">        <span class="keywordflow">if</span> (i2cWrite(ctrl) == I2C_NACK)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        i2cWrite((byte)(byteAddr &gt;&gt; 8));</div>
<div class="line">        i2cWrite((byte)byteAddr);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Start a bulk read operation.</span></div>
<div class="line"><span class="keywordtype">bool</span> startRead(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr)</div>
<div class="line">{</div>
<div class="line">    enterProgramMode();</div>
<div class="line">    i2cStart();</div>
<div class="line">    <span class="keywordflow">if</span> (!writeAddress(addr * 2))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    i2cStart();</div>
<div class="line">    <span class="keywordflow">return</span> i2cWrite(eepromI2CAddress | I2C_READ) == I2C_ACK;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Read the next 16-bit word from the EEPROM during a bulk read operation.</span></div>
<div class="line"><span class="comment">// If &quot;last&quot; is true then stop the bulk read operation after reading the word.</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> readWord(<span class="keywordtype">bool</span> last)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> value = i2cRead(I2C_ACK);</div>
<div class="line">    value |= ((<span class="keywordtype">unsigned</span> int)(i2cRead(last))) &lt;&lt; 8;</div>
<div class="line">    <span class="keywordflow">if</span> (last)</div>
<div class="line">        i2cStop();</div>
<div class="line">    <span class="keywordflow">return</span> value;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> writeByteAddr;</div>
<div class="line"><span class="keywordtype">bool</span> writeAddrNeeded;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Start a bulk write operation.</span></div>
<div class="line"><span class="keywordtype">void</span> startWrite(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr)</div>
<div class="line">{</div>
<div class="line">    enterProgramMode();</div>
<div class="line">    writeByteAddr = addr * 2;</div>
<div class="line">    writeAddrNeeded = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Write a 16-bit word during a bulk write operation.</span></div>
<div class="line"><span class="keywordtype">bool</span> writeWord(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (writeAddrNeeded) {</div>
<div class="line">        i2cStart();</div>
<div class="line">        <span class="keywordflow">if</span> (!writeAddress(writeByteAddr)) {</div>
<div class="line">            i2cStop();</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">        writeAddrNeeded = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    i2cWrite((byte)word);</div>
<div class="line">    <span class="keywordflow">if</span> (eepromPageSize == 1) {</div>
<div class="line">        <span class="comment">// 24LC00 needs a flush after every byte that is written.</span></div>
<div class="line">        i2cStop();</div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">            <span class="comment">// Poll until we get an acknowledgement from the EEPROM.</span></div>
<div class="line">            i2cStart();</div>
<div class="line">            <span class="keywordflow">if</span> (i2cWrite(eepromI2CAddress | I2C_WRITE) == I2C_ACK)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        i2cStop();</div>
<div class="line">        i2cStart();</div>
<div class="line">        <span class="keywordflow">if</span> (!writeAddress(writeByteAddr + 1)) {</div>
<div class="line">            i2cStop();</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    i2cWrite((byte)(word &gt;&gt; 8));</div>
<div class="line">    writeByteAddr += 2;</div>
<div class="line">    <span class="keywordflow">if</span> ((writeByteAddr % eepromPageSize) == 0) {</div>
<div class="line">        <span class="comment">// Overflow into the next page, so need to flush and send a new address.</span></div>
<div class="line">        i2cStop();</div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">            <span class="comment">// Poll until we get an acknowledgement from the EEPROM.</span></div>
<div class="line">            i2cStart();</div>
<div class="line">            <span class="keywordflow">if</span> (i2cWrite(eepromI2CAddress | I2C_WRITE) == I2C_ACK)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        i2cStop();</div>
<div class="line">        writeAddrNeeded = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Stop a bulk write operation.</span></div>
<div class="line"><span class="keywordtype">void</span> stopWrite()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!writeAddrNeeded) {</div>
<div class="line">        <span class="comment">// Flush the final page write operation.</span></div>
<div class="line">        i2cStop();</div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">            <span class="comment">// Poll until we get an acknowledgement from the EEPROM.</span></div>
<div class="line">            i2cStart();</div>
<div class="line">            <span class="keywordflow">if</span> (i2cWrite(eepromI2CAddress | I2C_WRITE) == I2C_ACK)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        i2cStop();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Erases all bytes within the EEPROM by setting them to 0xFF.</span></div>
<div class="line"><span class="keywordtype">bool</span> eraseAll()</div>
<div class="line">{</div>
<div class="line">    enterProgramMode();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Fill the bytes a page at a time.</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> startTime = millis();</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> currentTime;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> activity = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">while</span> (addr &lt; eepromSize) {</div>
<div class="line">        i2cStart();</div>
<div class="line">        <span class="keywordflow">if</span> (!writeAddress(addr))</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;   <span class="comment">// No device on the bus.</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count = 0; count &lt; eepromPageSize; ++count)</div>
<div class="line">            i2cWrite(0xFF);</div>
<div class="line">        i2cStop();</div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">            <span class="comment">// Poll until we get an acknowledgement from the EEPROM.</span></div>
<div class="line">            i2cStart();</div>
<div class="line">            <span class="keywordflow">if</span> (i2cWrite(eepromI2CAddress | I2C_WRITE) == I2C_ACK)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        i2cStop();</div>
<div class="line">        addr += eepromPageSize;</div>
<div class="line">        <span class="keywordflow">if</span> ((addr % 512) == 0) {</div>
<div class="line">            activity = !activity;</div>
<div class="line">            <span class="keywordflow">if</span> (activity)</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, HIGH);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">        }</div>
<div class="line">        currentTime = millis();</div>
<div class="line">        <span class="keywordflow">if</span> ((currentTime - startTime) &gt;= 2000) {</div>
<div class="line">            <span class="comment">// Erase has been running for too long, so ask the host to wait.</span></div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;PENDING&quot;</span>);</div>
<div class="line">            startTime = currentTime;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Probe the device to see if it is present on the bus.  We do this by</span></div>
<div class="line"><span class="comment">// doing a &quot;Current Address Read&quot; and checking for the presence of ACK bits.</span></div>
<div class="line"><span class="keywordtype">bool</span> probeDevice()</div>
<div class="line">{</div>
<div class="line">    enterProgramMode();</div>
<div class="line">    i2cStart();</div>
<div class="line">    <span class="keywordflow">if</span> (i2cWrite(eepromI2CAddress | I2C_READ) == I2C_NACK)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    i2cRead(I2C_NACK);</div>
<div class="line">    i2cStop();</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Jul 20 2013 14:30:05 for Ardpicprog by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
