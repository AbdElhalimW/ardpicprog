<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Ardpicprog: ProgramPIC sketch</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Ardpicprog
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ProgramPIC sketch </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This sketch should be uploaded to an Arduino Uno compatible board that has a <a class="el" href="pic14_zif_circuit.html">PIC programming shield</a> attached to it. The shield must be suitable for the PIC device that is being programmed. See the <a class="el" href="supported_devices.html">list of supported devices</a> for more information.</p>
<p>If you are programming an EEPROM from the 24LCXX family, then use the <a class="el" href="programeeprom_sketch.html">ProgramEEPROM</a> sketch instead.</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2012 Southern Storm Software, Pty Ltd.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This program is free software: you can redistribute it and/or modify</span></div>
<div class="line"><span class="comment"> * it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><span class="comment"> * the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="line"><span class="comment"> * (at your option) any later version.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><span class="comment"> * GNU General Public License for more details.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></div>
<div class="line"><span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define __PROG_TYPES_COMPAT__</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;avr/pgmspace.h&gt;</span>       <span class="comment">// For PROGMEM</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Pin mappings for the PIC programming shield.</span></div>
<div class="line"><span class="preprocessor">#define PIN_MCLR        A1      // 0: MCLR is VPP voltage, 1: Reset PIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_ACTIVITY    A5      // LED that indicates read/write activity</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_VDD         2       // Controls the power to the PIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_CLOCK       4       // Clock pin</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PIN_DATA        7       // Data pin</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MCLR_RESET      HIGH    // PIN_MCLR state to reset the PIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MCLR_VPP        LOW     // PIN_MCLR state to apply 13v to MCLR/VPP pin</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// All delays are in microseconds.</span></div>
<div class="line"><span class="preprocessor">#define DELAY_SETTLE    50      // Delay for lines to settle for reset</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TPPDP     5       // Hold time after raising MCLR</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_THLD0     5       // Hold time after raising VDD</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TSET1     1       // Data in setup time before lowering clock</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_THLD1     1       // Data in hold time after lowering clock</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TDLY2     1       // Delay between commands or data</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TDLY3     1       // Delay until data bit read will be valid</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TPROG     4000    // Time for a program memory write to complete</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TDPROG    6000    // Time for a data memory write to complete</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TERA      6000    // Time for a word erase to complete</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TPROG5    1000    // Time for program write on FLASH5 systems</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TFULLERA  50000   // Time for a full chip erase</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_TFULL84   20000   // Intermediate wait for PIC16F84/PIC16F84A</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Commands that may be sent to the device.</span></div>
<div class="line"><span class="preprocessor">#define CMD_LOAD_CONFIG         0x00    // Load (write) to config memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LOAD_PROGRAM_MEMORY 0x02    // Load to program memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LOAD_DATA_MEMORY    0x03    // Load to data memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_INCREMENT_ADDRESS   0x06    // Increment the PC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_READ_PROGRAM_MEMORY 0x04    // Read from program memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_READ_DATA_MEMORY    0x05    // Read from data memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_BEGIN_PROGRAM       0x08    // Begin programming with erase cycle</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_BEGIN_PROGRAM_ONLY  0x18    // Begin programming only cycle</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_END_PROGRAM_ONLY    0x17    // End programming only cycle</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_BULK_ERASE_PROGRAM  0x09    // Bulk erase program memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_BULK_ERASE_DATA     0x0B    // Bulk erase data memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_CHIP_ERASE          0x1F    // Erase the entire chip</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// States this application may be in.</span></div>
<div class="line"><span class="preprocessor">#define STATE_IDLE      0       // Idle, device is held in the reset state</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define STATE_PROGRAM   1       // Active, reading and writing program memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define STATE_CONFIG    2       // Active, reading and writing config memory</span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordtype">int</span> state = STATE_IDLE;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Flash types.  Uses a similar naming system to picprog.</span></div>
<div class="line"><span class="preprocessor">#define EEPROM          0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FLASH           1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FLASH4          4</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FLASH5          5</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pc = 0;           <span class="comment">// Current program counter.</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Flat address ranges for the various memory spaces.  Defaults to the values</span></div>
<div class="line"><span class="comment">// for the PIC16F628A.  &quot;DEVICE&quot; command updates to the correct values later.</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> programEnd    = 0x07FF;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> configStart   = 0x2000;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> configEnd     = 0x2007;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> dataStart     = 0x2100;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> dataEnd       = 0x217F;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reservedStart = 0x0800;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reservedEnd   = 0x07FF;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  configSave    = 0x0000;</div>
<div class="line">byte progFlashType          = FLASH4;</div>
<div class="line">byte dataFlashType          = EEPROM;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Device names, forced out into PROGMEM.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic12f629[]  PROGMEM = <span class="stringliteral">&quot;pic12f629&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic12f630[]  PROGMEM = <span class="stringliteral">&quot;pic12f630&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic12f675[]  PROGMEM = <span class="stringliteral">&quot;pic12f675&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic12f676[]  PROGMEM = <span class="stringliteral">&quot;pic12f676&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f84[]   PROGMEM = <span class="stringliteral">&quot;pic16f84&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f84a[]  PROGMEM = <span class="stringliteral">&quot;pic16f84a&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f87[]   PROGMEM = <span class="stringliteral">&quot;pic16f87&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f88[]   PROGMEM = <span class="stringliteral">&quot;pic16f88&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f627[]  PROGMEM = <span class="stringliteral">&quot;pic16f627&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f627a[] PROGMEM = <span class="stringliteral">&quot;pic16f627a&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f628[]  PROGMEM = <span class="stringliteral">&quot;pic16f628&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f628a[] PROGMEM = <span class="stringliteral">&quot;pic16f628a&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f648a[] PROGMEM = <span class="stringliteral">&quot;pic16f648a&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f882[]  PROGMEM = <span class="stringliteral">&quot;pic16f882&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f883[]  PROGMEM = <span class="stringliteral">&quot;pic16f883&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f884[]  PROGMEM = <span class="stringliteral">&quot;pic16f884&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f886[]  PROGMEM = <span class="stringliteral">&quot;pic16f886&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_pic16f887[]  PROGMEM = <span class="stringliteral">&quot;pic16f887&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// List of devices that are currently supported and their properties.</span></div>
<div class="line"><span class="comment">// Note: most of these are based on published information and have not</span></div>
<div class="line"><span class="comment">// been tested by the author.  Patches welcome to improve the list.</span></div>
<div class="line"><span class="keyword">struct </span>deviceInfo</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> prog_char *name;      <span class="comment">// User-readable name of the device.</span></div>
<div class="line">    prog_int16_t deviceId;      <span class="comment">// Device ID for the PIC (-1 if no id).</span></div>
<div class="line">    prog_uint32_t programSize;  <span class="comment">// Size of program memory (words).</span></div>
<div class="line">    prog_uint32_t configStart;  <span class="comment">// Flat address start of configuration memory.</span></div>
<div class="line">    prog_uint32_t dataStart;    <span class="comment">// Flat address start of EEPROM data memory.</span></div>
<div class="line">    prog_uint16_t configSize;   <span class="comment">// Number of configuration words.</span></div>
<div class="line">    prog_uint16_t dataSize;     <span class="comment">// Size of EEPROM data memory (bytes).</span></div>
<div class="line">    prog_uint16_t reservedWords;<span class="comment">// Reserved program words (e.g. for OSCCAL).</span></div>
<div class="line">    prog_uint16_t configSave;   <span class="comment">// Bits in config word to be saved.</span></div>
<div class="line">    prog_uint8_t progFlashType; <span class="comment">// Type of flash for program memory.</span></div>
<div class="line">    prog_uint8_t dataFlashType; <span class="comment">// Type of flash for data memory.</span></div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"><span class="keyword">struct </span>deviceInfo const devices[] PROGMEM = {</div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/41191D.pdf</span></div>
<div class="line">    {s_pic12f629,  0x0F80, 1024, 0x2000, 0x2100, 8, 128, 1, 0x3000, FLASH4, EEPROM},</div>
<div class="line">    {s_pic12f630,  0x10C0, 1024, 0x2000, 0x2100, 8, 128, 1, 0x3000, FLASH4, EEPROM},</div>
<div class="line">    {s_pic12f675,  0x0FC0, 1024, 0x2000, 0x2100, 8, 128, 1, 0x3000, FLASH4, EEPROM},</div>
<div class="line">    {s_pic12f676,  0x10E0, 1024, 0x2000, 0x2100, 8, 128, 1, 0x3000, FLASH4, EEPROM},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/30262e.pdf</span></div>
<div class="line">    {s_pic16f84,   -1,     1024, 0x2000, 0x2100, 8,  64, 0, 0, FLASH,  EEPROM},</div>
<div class="line">    {s_pic16f84a,  0x0560, 1024, 0x2000, 0x2100, 8,  64, 0, 0, FLASH,  EEPROM},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/39607c.pdf</span></div>
<div class="line">    {s_pic16f87,   0x0720, 4096, 0x2000, 0x2100, 9, 256, 0, 0, FLASH5, EEPROM},</div>
<div class="line">    {s_pic16f88,   0x0760, 4096, 0x2000, 0x2100, 9, 256, 0, 0, FLASH5, EEPROM},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 627/628:  http://ww1.microchip.com/downloads/en/DeviceDoc/30034d.pdf</span></div>
<div class="line">    <span class="comment">// A series: http://ww1.microchip.com/downloads/en/DeviceDoc/41196g.pdf</span></div>
<div class="line">    {s_pic16f627,  0x07A0, 1024, 0x2000, 0x2100, 8, 128, 0, 0, FLASH,  EEPROM},</div>
<div class="line">    {s_pic16f627a, 0x1040, 1024, 0x2000, 0x2100, 8, 128, 0, 0, FLASH4, EEPROM},</div>
<div class="line">    {s_pic16f628,  0x07C0, 2048, 0x2000, 0x2100, 8, 128, 0, 0, FLASH,  EEPROM},</div>
<div class="line">    {s_pic16f628a, 0x1060, 2048, 0x2000, 0x2100, 8, 128, 0, 0, FLASH4, EEPROM},</div>
<div class="line">    {s_pic16f648a, 0x1100, 4096, 0x2000, 0x2100, 8, 256, 0, 0, FLASH4, EEPROM},</div>
<div class="line"></div>
<div class="line">    <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/41287D.pdf</span></div>
<div class="line">    {s_pic16f882,  0x2000, 2048, 0x2000, 0x2100, 9, 128, 0, 0, FLASH4, EEPROM},</div>
<div class="line">    {s_pic16f883,  0x2020, 4096, 0x2000, 0x2100, 9, 256, 0, 0, FLASH4, EEPROM},</div>
<div class="line">    {s_pic16f884,  0x2040, 4096, 0x2000, 0x2100, 9, 256, 0, 0, FLASH4, EEPROM},</div>
<div class="line">    {s_pic16f886,  0x2060, 8192, 0x2000, 0x2100, 9, 256, 0, 0, FLASH4, EEPROM},</div>
<div class="line">    {s_pic16f887,  0x2080, 8192, 0x2000, 0x2100, 9, 256, 0, 0, FLASH4, EEPROM},</div>
<div class="line"></div>
<div class="line">    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Buffer for command-line character input and READBIN data packets.</span></div>
<div class="line"><span class="preprocessor">#define BINARY_TRANSFER_MAX 64</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BUFFER_MAX (BINARY_TRANSFER_MAX + 1)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordtype">char</span> buffer[BUFFER_MAX];</div>
<div class="line"><span class="keywordtype">int</span> buflen = 0;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lastActive = 0;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> setup()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Need a serial link to the host.</span></div>
<div class="line">    Serial.begin(9600);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Hold the PIC in the powered down/reset state until we are ready for it.</span></div>
<div class="line">    pinMode(PIN_MCLR, OUTPUT);</div>
<div class="line">    pinMode(PIN_VDD, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_MCLR, MCLR_RESET);</div>
<div class="line">    digitalWrite(PIN_VDD, LOW);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Clock and data are floating until the first PIC command.</span></div>
<div class="line">    pinMode(PIN_CLOCK, INPUT);</div>
<div class="line">    pinMode(PIN_DATA, INPUT);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Turn off the activity LED initially.</span></div>
<div class="line">    pinMode(PIN_ACTIVITY, OUTPUT);</div>
<div class="line">    digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> loop()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (Serial.available()) {</div>
<div class="line">        <span class="comment">// Process serial input for commands from the host.</span></div>
<div class="line">        <span class="keywordtype">int</span> ch = Serial.read();</div>
<div class="line">        <span class="keywordflow">if</span> (ch == 0x0A || ch == 0x0D) {</div>
<div class="line">            <span class="comment">// End of the current command.  Blank lines are ignored.</span></div>
<div class="line">            <span class="keywordflow">if</span> (buflen &gt; 0) {</div>
<div class="line">                buffer[buflen] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">                buflen = 0;</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, HIGH);   <span class="comment">// Turn on activity LED.</span></div>
<div class="line">                processCommand(buffer);</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, LOW);    <span class="comment">// Turn off activity LED.</span></div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == 0x08) {</div>
<div class="line">            <span class="comment">// Backspace over the last character.</span></div>
<div class="line">            <span class="keywordflow">if</span> (buflen &gt; 0)</div>
<div class="line">                --buflen;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buflen &lt; (BUFFER_MAX - 1)) {</div>
<div class="line">            <span class="comment">// Add the character to the buffer after forcing to upper case.</span></div>
<div class="line">            <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line">                buffer[buflen++] = ch - <span class="charliteral">&#39;a&#39;</span> + <span class="charliteral">&#39;A&#39;</span>;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                buffer[buflen++] = ch;</div>
<div class="line">        }</div>
<div class="line">        lastActive = millis();</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state != STATE_IDLE) {</div>
<div class="line">        <span class="comment">// Power off the programming socket if no activity for 2 seconds.</span></div>
<div class="line">        <span class="comment">// Normally the host will issue the &quot;PWROFF&quot; command, but if we are</span></div>
<div class="line">        <span class="comment">// operating in interactive mode or the host has crashed, then this</span></div>
<div class="line">        <span class="comment">// timeout will ensure that the system eventually enters safe mode.</span></div>
<div class="line">        <span class="keywordflow">if</span> ((millis() - lastActive) &gt;= 2000)</div>
<div class="line">            exitProgramMode();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printHex1(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (value &gt;= 10)</div>
<div class="line">        Serial.print((<span class="keywordtype">char</span>)(<span class="charliteral">&#39;A&#39;</span> + value - 10));</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        Serial.print((<span class="keywordtype">char</span>)(<span class="charliteral">&#39;0&#39;</span> + value));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printHex4(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word)</div>
<div class="line">{</div>
<div class="line">    printHex1((word &gt;&gt; 12) &amp; 0x0F);</div>
<div class="line">    printHex1((word &gt;&gt; 8) &amp; 0x0F);</div>
<div class="line">    printHex1((word &gt;&gt; 4) &amp; 0x0F);</div>
<div class="line">    printHex1(word &amp; 0x0F);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printHex8(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> word)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> upper = (<span class="keywordtype">unsigned</span> int)(word &gt;&gt; 16);</div>
<div class="line">    <span class="keywordflow">if</span> (upper)</div>
<div class="line">        printHex4(upper);</div>
<div class="line">    printHex4((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)word);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> printProgString(<span class="keyword">const</span> prog_char *str)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = (char)(pgm_read_byte(str));</div>
<div class="line">        <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        Serial.print(ch);</div>
<div class="line">        ++str;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// PROGRAM_PIC_VERSION command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdVersion(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;ProgramPIC 1.0&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Initialize device properties from the &quot;devices&quot; list and</span></div>
<div class="line"><span class="comment">// print them to the serial port.  Note: &quot;dev&quot; is in PROGMEM.</span></div>
<div class="line"><span class="keywordtype">void</span> initDevice(<span class="keyword">const</span> <span class="keyword">struct</span> deviceInfo *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Update the global device details.</span></div>
<div class="line">    programEnd = pgm_read_dword(&amp;(dev-&gt;programSize)) - 1;</div>
<div class="line">    configStart = pgm_read_dword(&amp;(dev-&gt;configStart));</div>
<div class="line">    configEnd = configStart + pgm_read_word(&amp;(dev-&gt;configSize)) - 1;</div>
<div class="line">    dataStart = pgm_read_dword(&amp;(dev-&gt;dataStart));</div>
<div class="line">    dataEnd = dataStart + pgm_read_word(&amp;(dev-&gt;dataSize)) - 1;</div>
<div class="line">    reservedStart = programEnd - pgm_read_word(&amp;(dev-&gt;reservedWords)) + 1;</div>
<div class="line">    reservedEnd = programEnd;</div>
<div class="line">    configSave = pgm_read_word(&amp;(dev-&gt;configSave));</div>
<div class="line">    progFlashType = pgm_read_byte(&amp;(dev-&gt;progFlashType));</div>
<div class="line">    dataFlashType = pgm_read_byte(&amp;(dev-&gt;dataFlashType));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Print the extra device information.</span></div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;DeviceName: &quot;</span>);</div>
<div class="line">    printProgString((<span class="keyword">const</span> prog_char *)(pgm_read_word(&amp;(dev-&gt;name))));</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;ProgramRange: 0000-&quot;</span>);</div>
<div class="line">    printHex8(programEnd);</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;ConfigRange: &quot;</span>);</div>
<div class="line">    printHex8(configStart);</div>
<div class="line">    Serial.print(<span class="charliteral">&#39;-&#39;</span>);</div>
<div class="line">    printHex8(configEnd);</div>
<div class="line">    Serial.println();</div>
<div class="line">    <span class="keywordflow">if</span> (configSave != 0) {</div>
<div class="line">        Serial.print(<span class="stringliteral">&quot;ConfigSave: &quot;</span>);</div>
<div class="line">        printHex4(configSave);</div>
<div class="line">        Serial.println();</div>
<div class="line">    }</div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;DataRange: &quot;</span>);</div>
<div class="line">    printHex8(dataStart);</div>
<div class="line">    Serial.print(<span class="charliteral">&#39;-&#39;</span>);</div>
<div class="line">    printHex8(dataEnd);</div>
<div class="line">    Serial.println();</div>
<div class="line">    <span class="keywordflow">if</span> (reservedStart &lt;= reservedEnd) {</div>
<div class="line">        Serial.print(<span class="stringliteral">&quot;ReservedRange: &quot;</span>);</div>
<div class="line">        printHex8(reservedStart);</div>
<div class="line">        Serial.print(<span class="charliteral">&#39;-&#39;</span>);</div>
<div class="line">        printHex8(reservedEnd);</div>
<div class="line">        Serial.println();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Offsets of interesting config locations that contain device information.</span></div>
<div class="line"><span class="preprocessor">#define DEV_USERID0         0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEV_USERID1         1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEV_USERID2         2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEV_USERID3         3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEV_ID              6</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEV_CONFIG_WORD     7</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// DEVICE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdDevice(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Make sure the device is reset before we start.</span></div>
<div class="line">    exitProgramMode();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Read identifiers and configuration words from config memory.</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> userid0 = readConfigWord(DEV_USERID0);</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> userid1 = readConfigWord(DEV_USERID1);</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> userid2 = readConfigWord(DEV_USERID2);</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> userid3 = readConfigWord(DEV_USERID3);</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> deviceId = readConfigWord(DEV_ID);</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> configWord = readConfigWord(DEV_CONFIG_WORD);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If the device ID is all-zeroes or all-ones, then it could mean</span></div>
<div class="line">    <span class="comment">// one of the following:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// 1. There is no PIC in the programming socket.</span></div>
<div class="line">    <span class="comment">// 2. The VPP programming voltage is not available.</span></div>
<div class="line">    <span class="comment">// 3. Code protection is enabled and the PIC is unreadable.</span></div>
<div class="line">    <span class="comment">// 4. The PIC is an older model with no device identifier.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Case 4 is the interesting one.  We look for any word in configuration</span></div>
<div class="line">    <span class="comment">// memory or the first 16 words of program memory that is non-zero.</span></div>
<div class="line">    <span class="comment">// If we find a non-zero word, we assume that we have a PIC but we</span></div>
<div class="line">    <span class="comment">// cannot detect what type it is.</span></div>
<div class="line">    <span class="keywordflow">if</span> (deviceId == 0 || deviceId == 0x3FFF) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word = userid0 | userid1 | userid2 | userid3 | configWord;</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> addr = 0;</div>
<div class="line">        <span class="keywordflow">while</span> (!word &amp;&amp; addr &lt; 16) {</div>
<div class="line">            word |= readWord(addr);</div>
<div class="line">            ++addr;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (!word) {</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            exitProgramMode();</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        deviceId = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line"></div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;DeviceID: &quot;</span>);</div>
<div class="line">    printHex4(deviceId);</div>
<div class="line">    Serial.println();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Find the device in the built-in list if we have details for it.</span></div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(devices[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name) {</div>
<div class="line">            index = -1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordtype">int</span> <span class="keywordtype">id</span> = pgm_read_word(&amp;(devices[index].deviceId));</div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == (deviceId &amp; 0xFFE0))</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (index &gt;= 0) {</div>
<div class="line">        initDevice(&amp;(devices[index]));</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Reset the global parameters to their defaults.  A separate</span></div>
<div class="line">        <span class="comment">// &quot;SETDEVICE&quot; command will be needed to set the correct values.</span></div>
<div class="line">        programEnd    = 0x07FF;</div>
<div class="line">        configStart   = 0x2000;</div>
<div class="line">        configEnd     = 0x2007;</div>
<div class="line">        dataStart     = 0x2100;</div>
<div class="line">        dataEnd       = 0x217F;</div>
<div class="line">        reservedStart = 0x0800;</div>
<div class="line">        reservedEnd   = 0x07FF;</div>
<div class="line">        configSave    = 0x0000;</div>
<div class="line">        progFlashType = FLASH4;</div>
<div class="line">        dataFlashType = EEPROM;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Serial.print(<span class="stringliteral">&quot;ConfigWord: &quot;</span>);</div>
<div class="line">    printHex4(configWord);</div>
<div class="line">    Serial.println();</div>
<div class="line"></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Don&#39;t need programming mode once the details have been read.</span></div>
<div class="line">    exitProgramMode();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// DEVICES command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdDevices(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(devices[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (index &gt; 0) {</div>
<div class="line">            Serial.print(<span class="charliteral">&#39;,&#39;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> ((index % 6) == 0)</div>
<div class="line">                Serial.println();</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                Serial.print(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">        }</div>
<div class="line">        printProgString(name);</div>
<div class="line">        <span class="keywordtype">int</span> <span class="keywordtype">id</span> = (int)(pgm_read_word(&amp;(devices[index].deviceId)));</div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keywordtype">id</span> != -1)</div>
<div class="line">            Serial.print(<span class="charliteral">&#39;*&#39;</span>);</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// SETDEVICE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdSetDevice(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Extract the name of the device from the command arguments.</span></div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = args[len];</div>
<div class="line">        <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;\0&#39;</span> || ch == <span class="charliteral">&#39; &#39;</span> || ch == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++len;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Look for the name in the devices list.</span></div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(devices[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (matchString(name, args, len)) {</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">            initDevice(&amp;(devices[index]));</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">            exitProgramMode(); <span class="comment">// Force a reset upon the next command.</span></div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> parseHex(<span class="keyword">const</span> <span class="keywordtype">char</span> *args, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> size = 0;</div>
<div class="line">    *value = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = *args;</div>
<div class="line">        <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;0&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;9&#39;</span>)</div>
<div class="line">            *value = (*value &lt;&lt; 4) | (ch - <span class="charliteral">&#39;0&#39;</span>);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;A&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;F&#39;</span>)</div>
<div class="line">            *value = (*value &lt;&lt; 4) | (ch - <span class="charliteral">&#39;A&#39;</span> + 10);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch &lt;= <span class="charliteral">&#39;f&#39;</span>)</div>
<div class="line">            *value = (*value &lt;&lt; 4) | (ch - <span class="charliteral">&#39;a&#39;</span> + 10);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++size;</div>
<div class="line">        ++args;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (*args != <span class="charliteral">&#39;\0&#39;</span> &amp;&amp; *args != <span class="charliteral">&#39;-&#39;</span> &amp;&amp; *args != <span class="charliteral">&#39; &#39;</span> &amp;&amp; *args != <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    <span class="keywordflow">return</span> size;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Parse a range of addresses of the form START or START-END.</span></div>
<div class="line"><span class="keywordtype">bool</span> parseRange(<span class="keyword">const</span> <span class="keywordtype">char</span> *args, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *end)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> size = parseHex(args, start);</div>
<div class="line">    <span class="keywordflow">if</span> (!size)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    args += size;</div>
<div class="line">    <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++args;</div>
<div class="line">    <span class="keywordflow">if</span> (*args != <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">        *end = *start;</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    ++args;</div>
<div class="line">    <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++args;</div>
<div class="line">    <span class="keywordflow">if</span> (!parseHex(args, end))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">return</span> *end &gt;= *start;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> parseCheckedRange(<span class="keyword">const</span> <span class="keywordtype">char</span> *args, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *end)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Parse the basic values and make sure that start &lt;= end.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!parseRange(args, start, end))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check that both start and end are within the same memory area</span></div>
<div class="line">    <span class="comment">// and within the bounds of that memory area.</span></div>
<div class="line">    <span class="keywordflow">if</span> (*start &lt;= programEnd) {</div>
<div class="line">        <span class="keywordflow">if</span> (*end &gt; programEnd)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*start &gt;= configStart &amp;&amp; *start &lt;= configEnd) {</div>
<div class="line">        <span class="keywordflow">if</span> (*end &lt; configStart || *end &gt; configEnd)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*start &gt;= dataStart &amp;&amp; *start &lt;= dataEnd) {</div>
<div class="line">        <span class="keywordflow">if</span> (*end &lt; dataStart || *end &gt; dataEnd)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// READ command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdRead(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> end;</div>
<div class="line">    <span class="keywordflow">if</span> (!parseCheckedRange(args, &amp;start, &amp;end)) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> activity = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">while</span> (start &lt;= end) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word = readWord(start);</div>
<div class="line">        <span class="keywordflow">if</span> (count &gt; 0) {</div>
<div class="line">            <span class="keywordflow">if</span> ((count % 8) == 0)</div>
<div class="line">                Serial.println();</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                Serial.print(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">        }</div>
<div class="line">        printHex4(word);</div>
<div class="line">        ++start;</div>
<div class="line">        ++count;</div>
<div class="line">        <span class="keywordflow">if</span> ((count % 32) == 0) {</div>
<div class="line">            <span class="comment">// Toggle the activity LED to make it blink during long reads.</span></div>
<div class="line">            activity = !activity;</div>
<div class="line">            <span class="keywordflow">if</span> (activity)</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, HIGH);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    Serial.println();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// READBIN command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdReadBinary(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> end;</div>
<div class="line">    <span class="keywordflow">if</span> (!parseCheckedRange(args, &amp;start, &amp;end)) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> activity = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordtype">size_t</span> offset = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (start &lt;= end) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word = readWord(start);</div>
<div class="line">        buffer[++offset] = (char)word;</div>
<div class="line">        buffer[++offset] = (char)(word &gt;&gt; 8);</div>
<div class="line">        <span class="keywordflow">if</span> (offset &gt;= BINARY_TRANSFER_MAX) {</div>
<div class="line">            <span class="comment">// Buffer is full - flush it to the host.</span></div>
<div class="line">            buffer[0] = (char)offset;</div>
<div class="line">            Serial.write((<span class="keyword">const</span> uint8_t *)buffer, offset + 1);</div>
<div class="line">            offset = 0;</div>
<div class="line">        }</div>
<div class="line">        ++start;</div>
<div class="line">        ++count;</div>
<div class="line">        <span class="keywordflow">if</span> ((count % 64) == 0) {</div>
<div class="line">            <span class="comment">// Toggle the activity LED to make it blink during long reads.</span></div>
<div class="line">            activity = !activity;</div>
<div class="line">            <span class="keywordflow">if</span> (activity)</div>
<div class="line">                digitalWrite(PIN_ACTIVITY, HIGH);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (offset &gt; 0) {</div>
<div class="line">        <span class="comment">// Flush the final packet before the terminator.</span></div>
<div class="line">        buffer[0] = (char)offset;</div>
<div class="line">        Serial.write((<span class="keyword">const</span> uint8_t *)buffer, offset + 1);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Write the terminator (a zero-length packet).</span></div>
<div class="line">    Serial.write((uint8_t)0x00);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_force[] PROGMEM = <span class="stringliteral">&quot;FORCE&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// WRITE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdWrite(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> limit;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> value;</div>
<div class="line">    <span class="keywordtype">int</span> size;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Was the &quot;FORCE&quot; option given?</span></div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (args[len] != <span class="charliteral">&#39;\0&#39;</span> &amp;&amp; args[len] != <span class="charliteral">&#39; &#39;</span> &amp;&amp; args[len] != <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++len;</div>
<div class="line">    <span class="keywordtype">bool</span> force = matchString(s_force, args, len);</div>
<div class="line">    <span class="keywordflow">if</span> (force) {</div>
<div class="line">        args += len;</div>
<div class="line">        <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            ++args;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    size = parseHex(args, &amp;addr);</div>
<div class="line">    <span class="keywordflow">if</span> (!size) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    args += size;</div>
<div class="line">    <span class="keywordflow">if</span> (addr &lt;= programEnd) {</div>
<div class="line">        limit = programEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr &gt;= configStart &amp;&amp; addr &lt;= configEnd) {</div>
<div class="line">        limit = configEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr &gt;= dataStart &amp;&amp; addr &lt;= dataEnd) {</div>
<div class="line">        limit = dataEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Address is not within one of the valid ranges.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            ++args;</div>
<div class="line">        <span class="keywordflow">if</span> (*args == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (*args == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        size = parseHex(args, &amp;value);</div>
<div class="line">        <span class="keywordflow">if</span> (!size) {</div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        args += size;</div>
<div class="line">        <span class="keywordflow">if</span> (addr &gt; limit) {</div>
<div class="line">            <span class="comment">// We&#39;ve reached the limit of this memory area, so fail.</span></div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (!force) {</div>
<div class="line">            <span class="keywordflow">if</span> (!writeWord(addr, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)value)) {</div>
<div class="line">                <span class="comment">// The actual write to the device failed.</span></div>
<div class="line">                Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> (!writeWordForced(addr, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)value)) {</div>
<div class="line">                <span class="comment">// The actual write to the device failed.</span></div>
<div class="line">                Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        ++addr;</div>
<div class="line">        ++count;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!count) {</div>
<div class="line">        <span class="comment">// Missing word argument.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Blocking serial read for use by WRITEBIN.</span></div>
<div class="line"><span class="keywordtype">int</span> readBlocking()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (!Serial.available())</div>
<div class="line">        ;   <span class="comment">// Do nothing.</span></div>
<div class="line">    <span class="keywordflow">return</span> Serial.read();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// WRITEBIN command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdWriteBinary(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> limit;</div>
<div class="line">    <span class="keywordtype">int</span> size;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Was the &quot;FORCE&quot; option given?</span></div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (args[len] != <span class="charliteral">&#39;\0&#39;</span> &amp;&amp; args[len] != <span class="charliteral">&#39; &#39;</span> &amp;&amp; args[len] != <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++len;</div>
<div class="line">    <span class="keywordtype">bool</span> force = matchString(s_force, args, len);</div>
<div class="line">    <span class="keywordflow">if</span> (force) {</div>
<div class="line">        args += len;</div>
<div class="line">        <span class="keywordflow">while</span> (*args == <span class="charliteral">&#39; &#39;</span> || *args == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            ++args;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    size = parseHex(args, &amp;addr);</div>
<div class="line">    <span class="keywordflow">if</span> (!size) {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    args += size;</div>
<div class="line">    <span class="keywordflow">if</span> (addr &lt;= programEnd) {</div>
<div class="line">        limit = programEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr &gt;= configStart &amp;&amp; addr &lt;= configEnd) {</div>
<div class="line">        limit = configEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr &gt;= dataStart &amp;&amp; addr &lt;= dataEnd) {</div>
<div class="line">        limit = dataEnd;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Address is not within one of the valid ranges.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> activity = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="comment">// Read in the next binary packet.</span></div>
<div class="line">        <span class="keywordtype">int</span> len = readBlocking();</div>
<div class="line">        <span class="keywordflow">while</span> (len == 0x0A &amp;&amp; count == 0) {</div>
<div class="line">            <span class="comment">// Skip 0x0A bytes before the first packet as they are</span></div>
<div class="line">            <span class="comment">// probably part of a CRLF pair rather than a packet length.</span></div>
<div class="line">            len = readBlocking();</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Stop if we have a zero packet length - end of upload.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!len)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Read the contents of the packet from the serial input stream.</span></div>
<div class="line">        <span class="keywordtype">int</span> offset = 0;</div>
<div class="line">        <span class="keywordflow">while</span> (offset &lt; len) {</div>
<div class="line">            <span class="keywordflow">if</span> (offset &lt; BINARY_TRANSFER_MAX) {</div>
<div class="line">                buffer[offset++] = (char)readBlocking();</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                readBlocking();     <span class="comment">// Packet is too big - discard extra bytes.</span></div>
<div class="line">                ++offset;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Write the words to memory.</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> posn = 0; posn &lt; (len - 1); posn += 2) {</div>
<div class="line">            <span class="keywordflow">if</span> (addr &gt; limit) {</div>
<div class="line">                <span class="comment">// We&#39;ve reached the limit of this memory area, so fail.</span></div>
<div class="line">                Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> value =</div>
<div class="line">                (((<span class="keywordtype">unsigned</span> int)buffer[posn]) &amp; 0xFF) |</div>
<div class="line">                ((((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)buffer[posn + 1]) &amp; 0xFF) &lt;&lt; 8);</div>
<div class="line">            <span class="keywordflow">if</span> (!force) {</div>
<div class="line">                <span class="keywordflow">if</span> (!writeWord(addr, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)value)) {</div>
<div class="line">                    <span class="comment">// The actual write to the device failed.</span></div>
<div class="line">                    Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">if</span> (!writeWordForced(addr, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)value)) {</div>
<div class="line">                    <span class="comment">// The actual write to the device failed.</span></div>
<div class="line">                    Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            ++addr;</div>
<div class="line">            ++count;</div>
<div class="line">            <span class="keywordflow">if</span> ((count % 24) == 0) {</div>
<div class="line">                <span class="comment">// Toggle the activity LED to make it blink during long writes.</span></div>
<div class="line">                activity = !activity;</div>
<div class="line">                <span class="keywordflow">if</span> (activity)</div>
<div class="line">                    digitalWrite(PIN_ACTIVITY, HIGH);</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    digitalWrite(PIN_ACTIVITY, LOW);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// All words in this packet have been written successfully.</span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_noPreserve[] PROGMEM = <span class="stringliteral">&quot;NOPRESERVE&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// ERASE command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdErase(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Was the &quot;NOPRESERVE&quot; option given?</span></div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (args[len] != <span class="charliteral">&#39;\0&#39;</span> &amp;&amp; args[len] != <span class="charliteral">&#39; &#39;</span> &amp;&amp; args[len] != <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++len;</div>
<div class="line">    <span class="keywordtype">bool</span> preserve = !matchString(s_noPreserve, args, len);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Preserve reserved words if necessary.</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *reserved = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> configWord = 0x3FFF;</div>
<div class="line">    <span class="keywordflow">if</span> (preserve &amp;&amp; reservedStart &lt;= reservedEnd) {</div>
<div class="line">        <span class="keywordtype">size_t</span> size = ((size_t)(reservedEnd - reservedStart + 1))</div>
<div class="line">            * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>);</div>
<div class="line">        reserved = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)malloc(size);</div>
<div class="line">        <span class="keywordflow">if</span> (reserved) {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr = reservedStart;</div>
<div class="line">            <span class="keywordtype">int</span> offset = 0;</div>
<div class="line">            <span class="keywordflow">while</span> (addr &lt;= reservedEnd) {</div>
<div class="line">                reserved[offset] = readWord(addr);</div>
<div class="line">                ++addr;</div>
<div class="line">                ++offset;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">// If we cannot preserve the reserved words, then abort now.</span></div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (configSave != 0 &amp;&amp; preserve) {</div>
<div class="line">        <span class="comment">// Some of the bits in the configuration word must also be saved.</span></div>
<div class="line">        configWord &amp;= ~configSave;</div>
<div class="line">        configWord |= readWord(configStart + DEV_CONFIG_WORD) &amp; configSave;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Perform the memory type specific erase sequence.</span></div>
<div class="line">    <span class="keywordflow">switch</span> (progFlashType) {</div>
<div class="line">    <span class="keywordflow">case</span> FLASH4:</div>
<div class="line">        setErasePC();</div>
<div class="line">        sendSimpleCommand(CMD_BULK_ERASE_PROGRAM);</div>
<div class="line">        delayMicroseconds(DELAY_TERA);</div>
<div class="line">        sendSimpleCommand(CMD_BULK_ERASE_DATA);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> FLASH5:</div>
<div class="line">        setErasePC();</div>
<div class="line">        sendSimpleCommand(CMD_CHIP_ERASE);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="comment">// Details for disabling code protection and erasing all memory</span></div>
<div class="line">        <span class="comment">// for PIC16F84/PIC16F84A comes from this doc, section 4.1:</span></div>
<div class="line">        <span class="comment">// http://ww1.microchip.com/downloads/en/DeviceDoc/30262e.pdf</span></div>
<div class="line">        setErasePC();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> count = 0; count &lt; 7; ++count)</div>
<div class="line">            sendSimpleCommand(CMD_INCREMENT_ADDRESS); <span class="comment">// Advance to 0x2007</span></div>
<div class="line">        sendSimpleCommand(0x01);    <span class="comment">// Command 1</span></div>
<div class="line">        sendSimpleCommand(0x07);    <span class="comment">// Command 7</span></div>
<div class="line">        sendSimpleCommand(CMD_BEGIN_PROGRAM);</div>
<div class="line">        delayMicroseconds(DELAY_TFULL84);</div>
<div class="line">        sendSimpleCommand(0x01);    <span class="comment">// Command 1</span></div>
<div class="line">        sendSimpleCommand(0x07);    <span class="comment">// Command 7</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Some FLASH devices need the data memory to be erased separately.</span></div>
<div class="line">        sendWriteCommand(CMD_LOAD_DATA_MEMORY, 0x3FFF);</div>
<div class="line">        sendSimpleCommand(CMD_BULK_ERASE_DATA);</div>
<div class="line">        sendSimpleCommand(CMD_BEGIN_PROGRAM);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Wait until the chip is fully erased.</span></div>
<div class="line">    delayMicroseconds(DELAY_TFULLERA);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Force the device to reset after it has been erased.</span></div>
<div class="line">    exitProgramMode();</div>
<div class="line">    enterProgramMode();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Write the reserved words back to program memory.</span></div>
<div class="line">    <span class="keywordflow">if</span> (reserved) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr = reservedStart;</div>
<div class="line">        <span class="keywordtype">int</span> offset = 0;</div>
<div class="line">        <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;</div>
<div class="line">        <span class="keywordflow">while</span> (addr &lt;= reservedEnd) {</div>
<div class="line">            <span class="keywordflow">if</span> (!writeWord(addr, reserved[offset]))</div>
<div class="line">                ok = <span class="keyword">false</span>;</div>
<div class="line">            ++addr;</div>
<div class="line">            ++offset;</div>
<div class="line">        }</div>
<div class="line">        free(reserved);</div>
<div class="line">        <span class="keywordflow">if</span> (!ok) {</div>
<div class="line">            <span class="comment">// Reserved words did not read back correctly.</span></div>
<div class="line">            Serial.println(<span class="stringliteral">&quot;ERROR&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Forcibly write 0x3FFF over the configuration words as erase</span></div>
<div class="line">    <span class="comment">// sometimes won&#39;t reset the words (e.g. PIC16F628A).  If the</span></div>
<div class="line">    <span class="comment">// write fails, then leave the words as-is - don&#39;t report the failure.</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> configAddr = configStart + DEV_CONFIG_WORD;</div>
<div class="line">            configAddr &lt;= configEnd; ++configAddr)</div>
<div class="line">        writeWordForced(configAddr, configWord);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Done.</span></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// PWROFF command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdPowerOff(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    exitProgramMode();</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// List of all commands that are understood by the programmer.</span></div>
<div class="line"><span class="keyword">typedef</span> void (*commandFunc)(<span class="keyword">const</span> <span class="keywordtype">char</span> *args);</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> prog_char *name;</div>
<div class="line">    commandFunc func;</div>
<div class="line">    <span class="keyword">const</span> prog_char *desc;</div>
<div class="line">    <span class="keyword">const</span> prog_char *args;</div>
<div class="line">} command_t;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdRead[] PROGMEM = <span class="stringliteral">&quot;READ&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Reads program and data words from device memory (text)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadArgs[] PROGMEM = <span class="stringliteral">&quot;STARTADDR[-ENDADDR]&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadBinary[] PROGMEM = <span class="stringliteral">&quot;READBIN&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdReadBinaryDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Reads program and data words from device memory (binary)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWrite[] PROGMEM = <span class="stringliteral">&quot;WRITE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Writes program and data words to device memory (text)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteArgs[] PROGMEM = <span class="stringliteral">&quot;STARTADDR WORD [WORD ...]&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteBinary[] PROGMEM = <span class="stringliteral">&quot;WRITEBIN&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteBinaryDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Writes program and data words to device memory (binary)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdWriteBinaryArgs[] PROGMEM = <span class="stringliteral">&quot;STARTADDR&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdErase[] PROGMEM = <span class="stringliteral">&quot;ERASE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdEraseDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Erases the contents of program, configuration, and data memory&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDevice[] PROGMEM = <span class="stringliteral">&quot;DEVICE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDeviceDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Probes the device and returns information about it&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDevices[] PROGMEM = <span class="stringliteral">&quot;DEVICES&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdDevicesDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Returns a list of all supported device types&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdSetDevice[] PROGMEM = <span class="stringliteral">&quot;SETDEVICE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdSetDeviceDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Sets a specific device type manually&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdSetDeviceArgs[] PROGMEM = <span class="stringliteral">&quot;DEVTYPE&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdPowerOff[] PROGMEM = <span class="stringliteral">&quot;PWROFF&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdPowerOffDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Powers off the device in the programming socket&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdVersion[] PROGMEM = <span class="stringliteral">&quot;PROGRAM_PIC_VERSION&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdVersionDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Prints the version of ProgramPIC&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdHelp[] PROGMEM = <span class="stringliteral">&quot;HELP&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> s_cmdHelpDesc[] PROGMEM =</div>
<div class="line">    <span class="stringliteral">&quot;Prints this help message&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> command_t commands[] PROGMEM = {</div>
<div class="line">    {s_cmdRead, cmdRead, s_cmdReadDesc, s_cmdReadArgs},</div>
<div class="line">    {s_cmdReadBinary, cmdReadBinary, s_cmdReadBinaryDesc, s_cmdReadArgs},</div>
<div class="line">    {s_cmdWrite, cmdWrite, s_cmdWriteDesc, s_cmdWriteArgs},</div>
<div class="line">    {s_cmdWriteBinary, cmdWriteBinary, s_cmdWriteBinaryDesc, s_cmdWriteBinaryArgs},</div>
<div class="line">    {s_cmdErase, cmdErase, s_cmdEraseDesc, 0},</div>
<div class="line">    {s_cmdDevice, cmdDevice, s_cmdDeviceDesc, 0},</div>
<div class="line">    {s_cmdDevices, cmdDevices, s_cmdDevicesDesc, 0},</div>
<div class="line">    {s_cmdSetDevice, cmdSetDevice, s_cmdSetDeviceDesc, s_cmdSetDeviceArgs},</div>
<div class="line">    {s_cmdPowerOff, cmdPowerOff, s_cmdPowerOffDesc, 0},</div>
<div class="line">    {s_cmdVersion, cmdVersion, s_cmdVersionDesc, 0},</div>
<div class="line">    {s_cmdHelp, cmdHelp, s_cmdHelpDesc, 0},</div>
<div class="line">    {0, 0}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// &quot;HELP&quot; command.</span></div>
<div class="line"><span class="keywordtype">void</span> cmdHelp(<span class="keyword">const</span> <span class="keywordtype">char</span> *args)</div>
<div class="line">{</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;OK&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keyword">const</span> prog_char *desc = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].desc)));</div>
<div class="line">        <span class="keyword">const</span> prog_char *args = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].args)));</div>
<div class="line">        printProgString(name);</div>
<div class="line">        <span class="keywordflow">if</span> (args) {</div>
<div class="line">            Serial.print(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">            printProgString(args);</div>
<div class="line">        }</div>
<div class="line">        Serial.println();</div>
<div class="line">        Serial.print(<span class="stringliteral">&quot;    &quot;</span>);</div>
<div class="line">        printProgString(desc);</div>
<div class="line">        Serial.println();</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Match a data-space string where the name comes from PROGMEM.</span></div>
<div class="line"><span class="keywordtype">bool</span> matchString(<span class="keyword">const</span> prog_char *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> len)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch1 = (char)(pgm_read_byte(name));</div>
<div class="line">        <span class="keywordflow">if</span> (ch1 == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">            <span class="keywordflow">return</span> len == 0;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len == 0)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (ch1 &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch1 &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line">            ch1 = ch1 - <span class="charliteral">&#39;a&#39;</span> + <span class="charliteral">&#39;A&#39;</span>;</div>
<div class="line">        <span class="keywordtype">char</span> ch2 = *str;</div>
<div class="line">        <span class="keywordflow">if</span> (ch2 &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; ch2 &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line">            ch2 = ch2 - <span class="charliteral">&#39;a&#39;</span> + <span class="charliteral">&#39;A&#39;</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (ch1 != ch2)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++name;</div>
<div class="line">        ++str;</div>
<div class="line">        --len;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Process commands from the host.</span></div>
<div class="line"><span class="keywordtype">void</span> processCommand(<span class="keyword">const</span> <span class="keywordtype">char</span> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Skip white space at the start of the command.</span></div>
<div class="line">    <span class="keywordflow">while</span> (*buf == <span class="charliteral">&#39; &#39;</span> || *buf == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++buf;</div>
<div class="line">    <span class="keywordflow">if</span> (*buf == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;     <span class="comment">// Ignore blank lines.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Extract the command portion of the line.</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd = buf;</div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordtype">char</span> ch = *buf;</div>
<div class="line">        <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;\0&#39;</span> || ch == <span class="charliteral">&#39; &#39;</span> || ch == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        ++buf;</div>
<div class="line">        ++len;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Skip white space after the command name and before the arguments.</span></div>
<div class="line">    <span class="keywordflow">while</span> (*buf == <span class="charliteral">&#39; &#39;</span> || *buf == <span class="charliteral">&#39;\t&#39;</span>)</div>
<div class="line">        ++buf;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Find the command and execute it.</span></div>
<div class="line">    <span class="keywordtype">int</span> index = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">const</span> prog_char *name = (<span class="keyword">const</span> prog_char *)</div>
<div class="line">            (pgm_read_word(&amp;(commands[index].name)));</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (matchString(name, cmd, len)) {</div>
<div class="line">            commandFunc func =</div>
<div class="line">                (commandFunc)(pgm_read_word(&amp;(commands[index].func)));</div>
<div class="line">            (*func)(buf);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        ++index;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Unknown command.</span></div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;NOTSUPPORTED&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Enter high voltage programming mode.</span></div>
<div class="line"><span class="keywordtype">void</span> enterProgramMode()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Bail out if already in programming mode.</span></div>
<div class="line">    <span class="keywordflow">if</span> (state != STATE_IDLE)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Lower MCLR, VDD, DATA, and CLOCK initially.  This will put the</span></div>
<div class="line">    <span class="comment">// PIC into the powered-off, reset state just in case.</span></div>
<div class="line">    digitalWrite(PIN_MCLR, MCLR_RESET);</div>
<div class="line">    digitalWrite(PIN_VDD, LOW);</div>
<div class="line">    digitalWrite(PIN_DATA, LOW);</div>
<div class="line">    digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Wait for the lines to settle.</span></div>
<div class="line">    delayMicroseconds(DELAY_SETTLE);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Switch DATA and CLOCK into outputs.</span></div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    pinMode(PIN_CLOCK, OUTPUT);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Raise MCLR, then VDD.</span></div>
<div class="line">    digitalWrite(PIN_MCLR, MCLR_VPP);</div>
<div class="line">    delayMicroseconds(DELAY_TPPDP);</div>
<div class="line">    digitalWrite(PIN_VDD, HIGH);</div>
<div class="line">    delayMicroseconds(DELAY_THLD0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Now in program mode, starting at the first word of program memory.</span></div>
<div class="line">    state = STATE_PROGRAM;</div>
<div class="line">    pc = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Exit programming mode and reset the device.</span></div>
<div class="line"><span class="keywordtype">void</span> exitProgramMode()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Nothing to do if already out of programming mode.</span></div>
<div class="line">    <span class="keywordflow">if</span> (state == STATE_IDLE)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Lower MCLR, VDD, DATA, and CLOCK.</span></div>
<div class="line">    digitalWrite(PIN_MCLR, MCLR_RESET);</div>
<div class="line">    digitalWrite(PIN_VDD, LOW);</div>
<div class="line">    digitalWrite(PIN_DATA, LOW);</div>
<div class="line">    digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Float the DATA and CLOCK pins.</span></div>
<div class="line">    pinMode(PIN_DATA, INPUT);</div>
<div class="line">    pinMode(PIN_CLOCK, INPUT);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Now in the idle state with the PIC powered off.</span></div>
<div class="line">    state = STATE_IDLE;</div>
<div class="line">    pc = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Send a command to the PIC.</span></div>
<div class="line"><span class="keywordtype">void</span> sendCommand(byte cmd)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (byte bit = 0; bit &lt; 6; ++bit) {</div>
<div class="line">        digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">        <span class="keywordflow">if</span> (cmd &amp; 1)</div>
<div class="line">            digitalWrite(PIN_DATA, HIGH);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            digitalWrite(PIN_DATA, LOW);</div>
<div class="line">        delayMicroseconds(DELAY_TSET1);</div>
<div class="line">        digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line">        delayMicroseconds(DELAY_THLD1);</div>
<div class="line">        cmd &gt;&gt;= 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Send a command to the PIC that has no arguments.</span></div>
<div class="line"><span class="keywordtype">void</span> sendSimpleCommand(byte cmd)</div>
<div class="line">{</div>
<div class="line">    sendCommand(cmd);</div>
<div class="line">    delayMicroseconds(DELAY_TDLY2);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Send a command to the PIC that writes a data argument.</span></div>
<div class="line"><span class="keywordtype">void</span> sendWriteCommand(byte cmd, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> data)</div>
<div class="line">{</div>
<div class="line">    sendCommand(cmd);</div>
<div class="line">    delayMicroseconds(DELAY_TDLY2);</div>
<div class="line">    <span class="keywordflow">for</span> (byte bit = 0; bit &lt; 16; ++bit) {</div>
<div class="line">        digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">        <span class="keywordflow">if</span> (data &amp; 1)</div>
<div class="line">            digitalWrite(PIN_DATA, HIGH);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            digitalWrite(PIN_DATA, LOW);</div>
<div class="line">        delayMicroseconds(DELAY_TSET1);</div>
<div class="line">        digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line">        delayMicroseconds(DELAY_THLD1);</div>
<div class="line">        data &gt;&gt;= 1;</div>
<div class="line">    }</div>
<div class="line">    delayMicroseconds(DELAY_TDLY2);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Send a command to the PIC that reads back a data value.</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sendReadCommand(byte cmd)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> data = 0;</div>
<div class="line">    sendCommand(cmd);</div>
<div class="line">    digitalWrite(PIN_DATA, LOW);</div>
<div class="line">    pinMode(PIN_DATA, INPUT);</div>
<div class="line">    delayMicroseconds(DELAY_TDLY2);</div>
<div class="line">    <span class="keywordflow">for</span> (byte bit = 0; bit &lt; 16; ++bit) {</div>
<div class="line">        data &gt;&gt;= 1;</div>
<div class="line">        digitalWrite(PIN_CLOCK, HIGH);</div>
<div class="line">        delayMicroseconds(DELAY_TDLY3);</div>
<div class="line">        <span class="keywordflow">if</span> (digitalRead(PIN_DATA))</div>
<div class="line">            data |= 0x8000;</div>
<div class="line">        digitalWrite(PIN_CLOCK, LOW);</div>
<div class="line">        delayMicroseconds(DELAY_THLD1);</div>
<div class="line">    }</div>
<div class="line">    pinMode(PIN_DATA, OUTPUT);</div>
<div class="line">    delayMicroseconds(DELAY_TDLY2);</div>
<div class="line">    <span class="keywordflow">return</span> data;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Set the program counter to a specific &quot;flat&quot; address.</span></div>
<div class="line"><span class="keywordtype">void</span> setPC(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (addr &gt;= dataStart &amp;&amp; addr &lt;= dataEnd) {</div>
<div class="line">        <span class="comment">// Data memory.</span></div>
<div class="line">        addr -= dataStart;</div>
<div class="line">        <span class="keywordflow">if</span> (state != STATE_PROGRAM || addr &lt; pc) {</div>
<div class="line">            <span class="comment">// Device is off, currently looking at configuration memory,</span></div>
<div class="line">            <span class="comment">// or the address is further back.  Reset the device.</span></div>
<div class="line">            exitProgramMode();</div>
<div class="line">            enterProgramMode();</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr &gt;= configStart &amp;&amp; addr &lt;= configEnd) {</div>
<div class="line">        <span class="comment">// Configuration memory.</span></div>
<div class="line">        addr -= configStart;</div>
<div class="line">        <span class="keywordflow">if</span> (state == STATE_IDLE) {</div>
<div class="line">            <span class="comment">// Enter programming mode and switch to config memory.</span></div>
<div class="line">            enterProgramMode();</div>
<div class="line">            sendWriteCommand(CMD_LOAD_CONFIG, 0);</div>
<div class="line">            state = STATE_CONFIG;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == STATE_PROGRAM) {</div>
<div class="line">            <span class="comment">// Switch from program memory to config memory.</span></div>
<div class="line">            sendWriteCommand(CMD_LOAD_CONFIG, 0);</div>
<div class="line">            state = STATE_CONFIG;</div>
<div class="line">            pc = 0;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr &lt; pc) {</div>
<div class="line">            <span class="comment">// Need to go backwards in config memory, so reset the device.</span></div>
<div class="line">            exitProgramMode();</div>
<div class="line">            enterProgramMode();</div>
<div class="line">            sendWriteCommand(CMD_LOAD_CONFIG, 0);</div>
<div class="line">            state = STATE_CONFIG;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Program memory.</span></div>
<div class="line">        <span class="keywordflow">if</span> (state != STATE_PROGRAM || addr &lt; pc) {</div>
<div class="line">            <span class="comment">// Device is off, currently looking at configuration memory,</span></div>
<div class="line">            <span class="comment">// or the address is further back.  Reset the device.</span></div>
<div class="line">            exitProgramMode();</div>
<div class="line">            enterProgramMode();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span> (pc &lt; addr) {</div>
<div class="line">        sendSimpleCommand(CMD_INCREMENT_ADDRESS);</div>
<div class="line">        ++pc;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Sets the PC for &quot;erase mode&quot;, which is activated by loading the</span></div>
<div class="line"><span class="comment">// data value 0x3FFF into location 0 of configuration memory.</span></div>
<div class="line"><span class="keywordtype">void</span> setErasePC()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Forcibly reset the device so we know what state it is in.</span></div>
<div class="line">    exitProgramMode();</div>
<div class="line">    enterProgramMode();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load 0x3FFF for the configuration.</span></div>
<div class="line">    sendWriteCommand(CMD_LOAD_CONFIG, 0x3FFF);</div>
<div class="line">    state = STATE_CONFIG;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Read a word from memory (program, config, or data depending upon addr).</span></div>
<div class="line"><span class="comment">// The start and stop bits will be stripped from the raw value from the PIC.</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> readWord(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr)</div>
<div class="line">{</div>
<div class="line">    setPC(addr);</div>
<div class="line">    <span class="keywordflow">if</span> (addr &gt;= dataStart &amp;&amp; addr &lt;= dataEnd)</div>
<div class="line">        <span class="keywordflow">return</span> (sendReadCommand(CMD_READ_DATA_MEMORY) &gt;&gt; 1) &amp; 0x00FF;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> (sendReadCommand(CMD_READ_PROGRAM_MEMORY) &gt;&gt; 1) &amp; 0x3FFF;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Read a word from config memory using relative, non-flat, addressing.</span></div>
<div class="line"><span class="comment">// Used by the &quot;DEVICE&quot; command to fetch information about devices whose</span></div>
<div class="line"><span class="comment">// flat address ranges are presently unknown.</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> readConfigWord(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (state == STATE_IDLE) {</div>
<div class="line">        <span class="comment">// Enter programming mode and switch to config memory.</span></div>
<div class="line">        enterProgramMode();</div>
<div class="line">        sendWriteCommand(CMD_LOAD_CONFIG, 0);</div>
<div class="line">        state = STATE_CONFIG;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == STATE_PROGRAM) {</div>
<div class="line">        <span class="comment">// Switch from program memory to config memory.</span></div>
<div class="line">        sendWriteCommand(CMD_LOAD_CONFIG, 0);</div>
<div class="line">        state = STATE_CONFIG;</div>
<div class="line">        pc = 0;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addr &lt; pc) {</div>
<div class="line">        <span class="comment">// Need to go backwards in config memory, so reset the device.</span></div>
<div class="line">        exitProgramMode();</div>
<div class="line">        enterProgramMode();</div>
<div class="line">        sendWriteCommand(CMD_LOAD_CONFIG, 0);</div>
<div class="line">        state = STATE_CONFIG;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span> (pc &lt; addr) {</div>
<div class="line">        sendSimpleCommand(CMD_INCREMENT_ADDRESS);</div>
<div class="line">        ++pc;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> (sendReadCommand(CMD_READ_PROGRAM_MEMORY) &gt;&gt; 1) &amp; 0x3FFF;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Begin a programming cycle, depending upon the type of flash being written.</span></div>
<div class="line"><span class="keywordtype">void</span> beginProgramCycle(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr, <span class="keywordtype">bool</span> isData)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (isData ? dataFlashType : progFlashType) {</div>
<div class="line">    <span class="keywordflow">case</span> FLASH:</div>
<div class="line">    <span class="keywordflow">case</span> EEPROM:</div>
<div class="line">        sendSimpleCommand(CMD_BEGIN_PROGRAM);</div>
<div class="line">        delayMicroseconds(DELAY_TDPROG + DELAY_TERA);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> FLASH4:</div>
<div class="line">        sendSimpleCommand(CMD_BEGIN_PROGRAM);</div>
<div class="line">        delayMicroseconds(DELAY_TPROG);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> FLASH5:</div>
<div class="line">        sendSimpleCommand(CMD_BEGIN_PROGRAM_ONLY);</div>
<div class="line">        delayMicroseconds(DELAY_TPROG5);</div>
<div class="line">        sendSimpleCommand(CMD_END_PROGRAM_ONLY);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Write a word to memory (program, config, or data depending upon addr).</span></div>
<div class="line"><span class="comment">// Returns true if the write succeeded, false if read-back failed to match.</span></div>
<div class="line"><span class="keywordtype">bool</span> writeWord(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> readBack;</div>
<div class="line">    setPC(addr);</div>
<div class="line">    <span class="keywordflow">if</span> (addr &gt;= dataStart &amp;&amp; addr &lt;= dataEnd) {</div>
<div class="line">        word &amp;= 0x00FF;</div>
<div class="line">        sendWriteCommand(CMD_LOAD_DATA_MEMORY, word &lt;&lt; 1);</div>
<div class="line">        beginProgramCycle(addr, <span class="keyword">true</span>);</div>
<div class="line">        readBack = sendReadCommand(CMD_READ_DATA_MEMORY);</div>
<div class="line">        readBack = (readBack &gt;&gt; 1) &amp; 0x00FF;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!configSave || addr != (configStart + DEV_CONFIG_WORD)) {</div>
<div class="line">        word &amp;= 0x3FFF;</div>
<div class="line">        sendWriteCommand(CMD_LOAD_PROGRAM_MEMORY, word &lt;&lt; 1);</div>
<div class="line">        beginProgramCycle(addr, <span class="keyword">false</span>);</div>
<div class="line">        readBack = sendReadCommand(CMD_READ_PROGRAM_MEMORY);</div>
<div class="line">        readBack = (readBack &gt;&gt; 1) &amp; 0x3FFF;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// The configuration word has calibration bits within it that</span></div>
<div class="line">        <span class="comment">// must be preserved when we write to it.  Read the current value</span></div>
<div class="line">        <span class="comment">// and preserve the necessary bits.</span></div>
<div class="line">        readBack = (sendReadCommand(CMD_READ_PROGRAM_MEMORY) &gt;&gt; 1) &amp; 0x3FFF;</div>
<div class="line">        word = (readBack &amp; configSave) | (word &amp; 0x3FFF &amp; ~configSave);</div>
<div class="line">        sendWriteCommand(CMD_LOAD_PROGRAM_MEMORY, word &lt;&lt; 1);</div>
<div class="line">        beginProgramCycle(addr, <span class="keyword">false</span>);</div>
<div class="line">        readBack = sendReadCommand(CMD_READ_PROGRAM_MEMORY);</div>
<div class="line">        readBack = (readBack &gt;&gt; 1) &amp; 0x3FFF;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> readBack == word;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Force a word to be written even if it normally would protect config bits.</span></div>
<div class="line"><span class="keywordtype">bool</span> writeWordForced(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> word)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> readBack;</div>
<div class="line">    setPC(addr);</div>
<div class="line">    <span class="keywordflow">if</span> (addr &gt;= dataStart &amp;&amp; addr &lt;= dataEnd) {</div>
<div class="line">        word &amp;= 0x00FF;</div>
<div class="line">        sendWriteCommand(CMD_LOAD_DATA_MEMORY, word &lt;&lt; 1);</div>
<div class="line">        beginProgramCycle(addr, <span class="keyword">true</span>);</div>
<div class="line">        readBack = sendReadCommand(CMD_READ_DATA_MEMORY);</div>
<div class="line">        readBack = (readBack &gt;&gt; 1) &amp; 0x00FF;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        word &amp;= 0x3FFF;</div>
<div class="line">        sendWriteCommand(CMD_LOAD_PROGRAM_MEMORY, word &lt;&lt; 1);</div>
<div class="line">        beginProgramCycle(addr, <span class="keyword">false</span>);</div>
<div class="line">        readBack = sendReadCommand(CMD_READ_PROGRAM_MEMORY);</div>
<div class="line">        readBack = (readBack &gt;&gt; 1) &amp; 0x3FFF;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> readBack == word;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Jul 20 2013 14:30:05 for Ardpicprog by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
